{
  "name": "Instagram Chatbot",
  "nodes": [
    {
      "parameters": {
        "multipleMethods": true,
        "path": "519ba340-1c3a-4882-bc31-9e2e9c29bf10",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2560,
        -336
      ],
      "id": "38bbe3bf-876e-4ba6-9a81-5e0416334168",
      "name": "Webhook",
      "webhookId": "519ba340-1c3a-4882-bc31-9e2e9c29bf10"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query['hub.challenge'] }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -2128,
        -768
      ],
      "id": "bbbcc62d-baa0-4dd3-bfcc-4b9f2b5dd9e4",
      "name": "Webhook Verification Handler"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "43c4a9eb-a972-4b0f-a10e-1228d0959e34",
              "leftValue": "={{ $json.query['hub.mode'] }}",
              "rightValue": "subscribe",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "fbb44e88-4bea-4db0-888f-458fbdf45e13",
              "leftValue": "={{ $json.query['hub.verify_token'] }}",
              "rightValue": "test11",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2320,
        -464
      ],
      "id": "b804e076-4520-46d1-a810-fc6721e1e45e",
      "name": "If"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.entry[0].messaging[0].message.text }}",
        "options": {
          "systemMessage": "You are a helpful assistant\nMaximum output 500 characters"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        3072,
        -464
      ],
      "id": "a1ca3108-b09f-4969-94f2-23bc5cc1fd27",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3008,
        -288
      ],
      "id": "9559c7b7-a254-487c-9825-797893fefc38",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "FxVWaStn8r9LRgtp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.entry[0].messaging[0].message.attachments }}",
                    "rightValue": "",
                    "operator": {
                      "type": "array",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "97cd797d-f02d-4d34-94c1-524c405ff43b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Attachments"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "49613158-3841-407a-80da-57613cb9a9b3",
                    "leftValue": "={{ $json.body.entry[0].changes[0].field }}",
                    "rightValue": "comments",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Commenta"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e835af6b-97a7-4cd5-9a6c-0f9829a139b3",
                    "leftValue": "={{ $json.body.entry[0].messaging }}",
                    "rightValue": "",
                    "operator": {
                      "type": "array",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DM message"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2320,
        -304
      ],
      "id": "fcf12427-b86c-43f8-967f-aaba3b488f79",
      "name": "Message Type Router"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f7330dcc-5c33-4c1a-b160-eab81ceefd6a",
              "leftValue": "={{ $json.body.entry[0].messaging[0].message.is_echo }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": "=",
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2064,
        -192
      ],
      "id": "706b79ba-670c-4e37-a271-127fa4e3e31a",
      "name": "Check Echo"
    },
    {
      "parameters": {
        "height": 480,
        "width": 528
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2608,
        -544
      ],
      "typeVersion": 1,
      "id": "1b72f288-36bb-4f9e-b978-dbc4ee020c60",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Test Processing Pipeline\n",
        "height": 528,
        "width": 624,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1840,
        -960
      ],
      "typeVersion": 1,
      "id": "dc8e73f6-c0d2-4b55-859d-3d6079460e0e",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "45f6e3eb-9156-4952-a9be-bbe8f94775a7",
              "name": "text_message",
              "value": "={{ $json.output }}",
              "type": "string"
            },
            {
              "id": "fb4cc668-4549-460b-b499-d142e3e73da5",
              "name": "recipient_id",
              "value": "={{ $('Webhook').item.json.body.entry[0].messaging[0].sender.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3360,
        -464
      ],
      "id": "e4b72486-9b51-45a0-8965-bc785792901b",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v23.0/796534800210682/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAQL9sLFV1EBPw92ytW0g3s0gizhks76afaYCUKdvUvdKIHgHbBVr9rDNvd2uZChY7k0eoMuj0wjiJpSpgBFzjbnFL2P6RlvA6R8u1JrFltU8436ZBd0oLxN02AwlwcdLfdi9UA6zKFsDuy17RX0yMj90ygdtzCtyT8ypoVzX2Q6sHssQZAhvsdEwWCjLMQSDeW"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"message\": {\n    \"text\": \"{{ $json.text_message.replace(/\\\"/g, '\\\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2544,
        -720
      ],
      "id": "c28f970c-cbc1-4146-ba36-2220a924469e",
      "name": "Send Text Response"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f7330dcc-5c33-4c1a-b160-eab81ceefd6a",
              "leftValue": "={{ $json.body.entry[0].messaging[0].message.is_echo }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": "=",
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2064,
        -416
      ],
      "id": "62b3b709-0257-40a4-a576-142b27ef66ff",
      "name": "Check Echo1"
    },
    {
      "parameters": {
        "url": "={{ $json.body.entry[0].messaging[0].message.attachments[0].payload.url }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1696,
        1376
      ],
      "id": "746da2bc-09ce-419e-8455-09ef7fdece67",
      "name": "HTTP Request",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "text": "=What's in this image?\n\nNote: \n1. Message lenght should be less than 200 character",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1888,
        1376
      ],
      "id": "b0df2d9d-2c48-417f-99eb-aa47ca2c4fa5",
      "name": "Analyze image",
      "credentials": {
        "openAiApi": {
          "id": "qMzQzCXwX6VZAvXL",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "45f6e3eb-9156-4952-a9be-bbe8f94775a7",
              "name": "text_message",
              "value": "={{ $json.content }}",
              "type": "string"
            },
            {
              "id": "fb4cc668-4549-460b-b499-d142e3e73da5",
              "name": "recipient_id",
              "value": "={{ $('Webhook').item.json.body.entry[0].messaging[0].sender.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2128,
        1376
      ],
      "id": "b4def7e3-f220-4839-8e15-2c58dcfccc63",
      "name": "Prepare Image Response Data"
    },
    {
      "parameters": {
        "content": "## Image Preocessing Pipeline\n",
        "height": 288,
        "width": 592,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1680,
        1296
      ],
      "typeVersion": 1,
      "id": "b88bc47c-15ac-458d-a33b-eb21e71c9410",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Response Handler \n",
        "height": 240,
        "width": 272
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2464,
        -800
      ],
      "typeVersion": 1,
      "id": "b933af25-10b5-4a52-9989-b374b3f0cc5f",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "method": "=GET",
        "url": "={{ $json.body.entry[0].messaging[0].message.attachments[0].payload.url }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1696,
        1872
      ],
      "id": "1f492f58-02a3-4507-b770-9ba8b37cc97d",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1936,
        1856
      ],
      "id": "c06c0f6d-6048-4957-9646-5bf606dfab4d",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "qMzQzCXwX6VZAvXL",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}",
        "options": {
          "systemMessage": "You are a helpful assistant"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        2096,
        1856
      ],
      "id": "82b78302-f97d-466b-9939-34143514632f",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2064,
        2080
      ],
      "id": "2561b233-67dc-445b-8795-4753998a3185",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "FxVWaStn8r9LRgtp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3f805813-50de-4452-b67f-0051fc0ec1ab",
              "leftValue": "={{ $('HTTP Request1').item.json.body.entry[0].messaging[0].message.attachments[0].type }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2416,
        1856
      ],
      "id": "6558c443-7247-4fd7-a4c4-4d634e483f77",
      "name": "Audio Response Type Check"
    },
    {
      "parameters": {
        "resource": "audio",
        "input": "={{ $json.output }}",
        "voice": "shimmer",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        3088,
        1824
      ],
      "id": "4e84d02d-4e81-4e66-aa7a-10306c144c64",
      "name": "Generate AI Voice Response",
      "credentials": {
        "openAiApi": {
          "id": "qMzQzCXwX6VZAvXL",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "name": "audio_file.wav",
        "driveId": {
          "__rl": true,
          "value": "My Drive",
          "mode": "list",
          "cachedResultName": "My Drive",
          "cachedResultUrl": "https://drive.google.com/drive/my-drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1Q2ZOMCJE1WUpcLE8k3HVGRfNRG1Xb9dI",
          "mode": "list",
          "cachedResultName": "ChatBot Voice Messages",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1Q2ZOMCJE1WUpcLE8k3HVGRfNRG1Xb9dI"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3488,
        1824
      ],
      "id": "e2f52eb6-43fb-41b2-89df-403bc097d31b",
      "name": "Upload Audio to Drive",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "kZA0ic6ffpDXSu7G",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').item.json.body.entry[0].messaging[0].sender.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        2224,
        2080
      ],
      "id": "78889629-27c5-4684-8bba-72a441b88a69",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').item.json.body.entry[0].messaging[0].sender.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3152,
        -288
      ],
      "id": "4724b262-e846-41d4-87a6-21f04b9a3bfa",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "content": "## Audio Processsing Pipeline\n",
        "height": 592,
        "width": 1792,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1680,
        1728
      ],
      "typeVersion": 1,
      "id": "d4b9bbab-3a37-4dd0-b90a-73ea542e5baf",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "httpRequestMethod": "POST",
        "graphApiVersion": "v23.0",
        "node": "me ",
        "options": {}
      },
      "type": "n8n-nodes-base.facebookGraphApi",
      "typeVersion": 1,
      "position": [
        6000,
        -688
      ],
      "id": "c7319abc-7d28-4256-aabe-f3ec92ce3e3c",
      "name": "Facebook Graph API",
      "credentials": {
        "facebookGraphApi": {
          "id": "0HHONI90xWYRRNSa",
          "name": "Facebook Graph account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v17.0/%3CPAGE_ID%3E/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer <PAGE_ACCESS_TOKEN>"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"recipient\": {\n    \"id\": \"<USER_ID>\"\n  },\n  \"sender_action\": \"typing_off\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6304,
        336
      ],
      "id": "b84c460f-f391-4f9f-9105-3f06c4070097",
      "name": "typing_off",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAQL9sLFV1EBPw92ytW0g3s0gizhks76afaYCUKdvUvdKIHgHbBVr9rDNvd2uZChY7k0eoMuj0wjiJpSpgBFzjbnFL2P6RlvA6R8u1JrFltU8436ZBd0oLxN02AwlwcdLfdi9UA6zKFsDuy17RX0yMj90ygdtzCtyT8ypoVzX2Q6sHssQZAhvsdEwWCjLMQSDeW"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"typing_on\"\n} ",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1904,
        -752
      ],
      "id": "469a3867-06e6-4f74-9a70-10654989eabc",
      "name": "typing_on"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6304,
        -352
      ],
      "id": "3c848cd0-6ea6-4c88-824c-cffb6b73f81e",
      "name": "url_button",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6304,
        -192
      ],
      "id": "0acb35b8-de41-40d9-8928-75931c5537f8",
      "name": "persistent_menu",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6304,
        -496
      ],
      "id": "2209973d-80cf-487e-b35a-5a8345092634",
      "name": "postback_button",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5920,
        256
      ],
      "id": "66e3087d-492c-439a-9ca7-f1f664cfb612",
      "name": "call_button",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6304,
        -16
      ],
      "id": "5e9e757b-40a2-4e75-8e4d-dfdeae483966",
      "name": "quick_reply",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5840,
        64
      ],
      "id": "ab02a317-3b3b-4f70-a50d-b78abb7cffa1",
      "name": "quick_reply_phone_number",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5872,
        -144
      ],
      "id": "5b733bfd-1deb-4f10-88b0-89a1cdd1a881",
      "name": "quick_reply_email",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6160,
        128
      ],
      "id": "1aba3c05-b424-4838-b5f2-77e40b4e8066",
      "name": "button_template",
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5904,
        528
      ],
      "id": "83bed291-911b-42ad-bc7b-5a310c3f96c6",
      "name": "HTTP Request9",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6416,
        -688
      ],
      "id": "a4aa4956-8d9d-4a62-850d-e83c03608ff4",
      "name": "HTTP Request10",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAQL9sLFV1EBPw92ytW0g3s0gizhks76afaYCUKdvUvdKIHgHbBVr9rDNvd2uZChY7k0eoMuj0wjiJpSpgBFzjbnFL2P6RlvA6R8u1JrFltU8436ZBd0oLxN02AwlwcdLfdi9UA6zKFsDuy17RX0yMj90ygdtzCtyT8ypoVzX2Q6sHssQZAhvsdEwWCjLMQSDeW"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"mark_seen\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1904,
        -928
      ],
      "id": "887351f0-cb89-4248-976d-c45d5e5a9284",
      "name": "mark_seen"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v17.0/%3CPAGE_ID%3E/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer <PAGE_ACCESS_TOKEN>"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"recipient\": {\n    \"id\": \"<USER_ID>\"\n  },\n  \"message\": {\n    \"attachment\": {\n      \"type\": \"template\",\n      \"payload\": {\n        \"template_type\": \"generic\",\n        \"elements\": [\n          {\n            \"title\": \"Check this out\",\n            \"image_url\": \"<IMAGE_URL>\",\n            \"subtitle\": \"Click to go\",\n            \"default_action\": {\n              \"type\": \"web_url\",\n              \"url\": \"https://deine-zielseite.de\",\n              \"webview_height_ratio\": \"tall\"\n            },\n            \"buttons\": [\n              {\n                \"type\": \"web_url\",\n                \"url\": \"https://deine-zielseite.de\",\n                \"title\": \"Go to site\"\n              }\n            ]\n          }\n        ]\n      }\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6304,
        160
      ],
      "id": "a0fcea01-d727-4cae-8962-4077410ad14e",
      "name": "template",
      "disabled": true
    },
    {
      "parameters": {
        "unit": "=seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1904,
        -560
      ],
      "id": "6edc3e7f-b905-4392-a7af-ca8607d821f7",
      "name": "Wait",
      "webhookId": "4dd1678c-fd73-4db3-a990-7ba4cbc927f2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"typing_on\"\n} ",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2352,
        1280
      ],
      "id": "33ba9462-2359-4d66-9f27-2edcd11bc334",
      "name": "typing_on1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"mark_seen\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2352,
        1376
      ],
      "id": "316e4059-df78-4215-a2cf-236b36977ee1",
      "name": "mark_seen1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "unit": "=seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2352,
        1536
      ],
      "id": "26e67e47-aab8-4fb5-8401-457cd252f6cc",
      "name": "Wait1",
      "webhookId": "4dd1678c-fd73-4db3-a990-7ba4cbc927f2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/message_attachments",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"platform\": \"instagram\",\n  \"message\": {\n    \"attachment\": {\n      \"type\": \"audio\",\n      \"payload\": {\n        \"url\": \"{{ $json.webContentLink }}\",\n        \"is_reusable\": true\n      }\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3712,
        1824
      ],
      "id": "98b422e2-0a8b-48d4-8ac2-28f9c6b42553",
      "name": "Upload to Meta",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $('HTTP Request1').item.json.body.entry[0].messaging[0].sender.id }}\"\n  },\n  \"message\": {\n    \"attachment\": {\n      \"type\": \"audio\",\n      \"payload\": {\n        \"attachment_id\": \"{{ $json.attachment_id }}\"\n      }\n    }\n  },\n  \"platform\": \"instagram\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3968,
        1824
      ],
      "id": "3d8dc983-a328-433c-86bb-5734b783829c",
      "name": "Send Voice Message",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $('HTTP Request1').item.json.body.entry[0].messaging[0].sender.id }}\"\n  },\n  \"message\": {\n    \"attachment\": {\n      \"type\": \"audio\",\n      \"payload\": {\n        \"url\": \"{{ $json.webContentLink }}\"\n      }\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6112,
        -288
      ],
      "id": "b2f5f9d1-082c-4229-9161-872211f9100a",
      "name": "HTTP Request2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudconvert.com/v2/jobs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiIxIiwianRpIjoiZmRhZWJmYjJkZjliNDE1OGU2NjI3ZjhmM2M4Y2VkMDg1OGFjMDE3YWM5YmIyNzQ2ZThmODkxODc2NDZlY2IwMjdjYmJiMzljNzg3MjFkMjIiLCJpYXQiOjE3NTk5MzUzMjguOTcyOTU3LCJuYmYiOjE3NTk5MzUzMjguOTcyOTU4LCJleHAiOjQ5MTU2MDg5MjguOTY2OTIsInN1YiI6IjczMTI5ODE4Iiwic2NvcGVzIjpbInVzZXIucmVhZCIsInVzZXIud3JpdGUiLCJ0YXNrLnJlYWQiLCJ0YXNrLndyaXRlIiwid2ViaG9vay5yZWFkIiwid2ViaG9vay53cml0ZSIsInByZXNldC5yZWFkIiwicHJlc2V0LndyaXRlIl19.E-WfNSvRgI9fmy_y7Zom-01mlVZH-2Ni_2WicvMT2Fda9IGNgJijasCwrDl7u1BkrWEYP93djLphGpPHZFaSuvtdUqcoF9Rfx-q-hWuLr-3fvEmn1Wq6ybRD1W5GV7flsb8S9rCdOKWAftTIYdzLw0q5uLBhR1RuK9_8aYWIltCYQUYHIDL60xWlNjoFR44bjnl12-7s2njNJOdxB2QdLrcWlxWI0uLN4mnhPKDFta_DuBxhZSDXYcI1Eby_UCi9deVXvNkp0cICBkwEgGkTGelyAEeBRDE4qLnbL3byhZjIl_mRNl27oCtCOVttkRClbmPDyIthDaQN1M5ExBduffMZKVN2Gdz-ZPmkezV2gFSqRdtPoXIbvyvE0ijhEwHG502DezM32VT_YlyYqCHWj7qXkYSb8hftf35CX3tUPZAbSXcPgeo-m-rnSKj35sfuIRdWlrXYH5udOJ4g1PhmjOPvbKHsKYQAnLtnIVGfQ-ofWYtHgNSQdeiRXjl6D5i2ZnI9-eBWZlnAzNLlNth_3maYxxfQbhq2TnKADpPdV0xd2zsYWAsCrlTdReXqYVfppDdZTw_zAjR-qnzMQRyQb_Nb3evoxn8fRN4hkrmNKlK93EIe2GeOIQ6-G1tjSyeMTQhNYgZL8n8G-k2r4c0-X4EcvYmyc0hfIm6vwy-CV4g"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tasks\": {\n    \"import-my-file\": {\n      \"operation\": \"import/url\",\n      \"url\": \"{{ $json.webContentLink }}\"\n    },\n    \"convert-my-file\": {\n      \"operation\": \"convert\",\n      \"input\": \"import-my-file\",\n      \"output_format\": \"m4a\",\n      \"audio_codec\": \"aac\",\n      \"audio_bitrate\": 128\n    },\n    \"export-my-file\": {\n      \"operation\": \"export/url\",\n      \"input\": \"convert-my-file\"\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6112,
        -480
      ],
      "id": "69bcbf49-2ff4-4d1d-868b-43d0884b4131",
      "name": "HTTP Request3",
      "disabled": true
    },
    {
      "parameters": {
        "outputFormat": "wav"
      },
      "type": "@cloudconvert/n8n-nodes-cloudconvert.cloudConvert",
      "typeVersion": 1,
      "position": [
        3280,
        1824
      ],
      "id": "d8214bd1-0ff6-4f2a-8d0c-71857f5083f8",
      "name": "CloudConvert",
      "credentials": {
        "cloudConvertOAuth2Api": {
          "id": "l5iluqNWfbJlInTg",
          "name": "CloudConvert account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAQL9sLFV1EBPg7ZCx9FZAReG50Fif8gZBGO8JlLqlOxrZAMkbe2u4dg5j7uTVRWu5HTEhNJZBZCfriw3ZAUYAA2hcy2ktIlMHdR6Y1C32KBEsdeLDyx0IZCAfdGC8eWAH4c1ZAVNCe6vA0FYZAhYzcbZBE2E6PUDGRY2FZBJktokl4W1P2VfXZCe8BdtZBEK2nf78znf5ICNS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"mark_seen\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1856,
        2016
      ],
      "id": "a011fec6-a7ca-4523-ae7c-f7e10b6366d4",
      "name": "mark_seen2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "unit": "=seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1856,
        2176
      ],
      "id": "e32fa23b-5d38-4d85-a0b2-6d8a5ef79ab4",
      "name": "Wait2",
      "webhookId": "4dd1678c-fd73-4db3-a990-7ba4cbc927f2"
    },
    {
      "parameters": {
        "content": "## Response Handler \n",
        "height": 256,
        "width": 272
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3888,
        1760
      ],
      "typeVersion": 1,
      "id": "b34b73f8-1b51-474e-b308-dd1d9d199831",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "jsCode": "// Generate a random number between 0 and 1\nconst random = Math.random();\n\n// Bias: 20% chance for voice (random < 0.2), else text\nif (random < 0.2) {\n  return { decision: 'voice' };  // Output for voice path\n} else {\n  return { decision: 'text' };   // Output for text path\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2640,
        1840
      ],
      "id": "171b15be-90f5-433b-b402-281a82295672",
      "name": "Randomizer"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.decision }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "699f18b6-048a-4bb0-9c18-863c7c0a3863"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice "
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ea95cf74-0ca1-4faa-a684-51b9ebc34df1",
                    "leftValue": "={{ $json.decision }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2864,
        1840
      ],
      "id": "6a332adb-8e67-49a8-9484-888d98d58b0c",
      "name": "Switch1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.entry[0].messaging[0].message.attachments[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "2919c51c-7053-477e-a7c7-54f4860e8e1f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cf8370ef-5e3f-4769-8aef-171e123d2b74",
                    "leftValue": "={{ $json.body.entry[0].messaging[0].message.attachments[0].type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1216,
        1840
      ],
      "id": "fe425c61-65d0-4dee-aa65-e2643d6c4566",
      "name": "Content type switch"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1nKHHmjL8qVcz-jz0uBAN_WCE4tcs99WjA3rTR4Rx0Io",
          "mode": "list",
          "cachedResultName": "Whitelist (keine automatisierten Nachrichten)",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nKHHmjL8qVcz-jz0uBAN_WCE4tcs99WjA3rTR4Rx0Io/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nKHHmjL8qVcz-jz0uBAN_WCE4tcs99WjA3rTR4Rx0Io/edit#gid=0"
        },
        "options": {}
      },
      "id": "7ce17cd7-6902-49e7-9e1f-2ecd87596024",
      "name": "Lookup in Friends Whitelist",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1616,
        -944
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "whitelist-check-001",
              "leftValue": "={{ $json.user_id }}",
              "rightValue": "=",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "61221dd1-ac28-4938-a165-e15aae1f21af",
      "name": "IF Friend? (Whitelist Check)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -752,
        -1312
      ],
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseCode": 200
        }
      },
      "id": "a9979948-75c8-4487-832b-c474a0ad853f",
      "name": "Silent Response (Friend)1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -992,
        -1200
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "user_id",
              "lookupValue": "={{ $json.instagram_user_id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e52fb35f-401d-4e59-ad2b-ffb7e4623ba4",
      "name": "CRM - Lookup User",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -848,
        -944
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "user-exists-check-001",
              "leftValue": "={{ $json.user_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6507512c-7ba3-44cf-986b-5ce2ad833005",
      "name": "IF User Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -656,
        -944
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c537fe8-a588-4526-86e5-512464e74807",
              "name": "=user_id",
              "value": "={{ $('CRM - Lookup User').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "27619db6-83fc-45fc-a548-2d101b4a4975",
              "name": "=username",
              "value": "={{ $('CRM - Lookup User').item.json.username }}",
              "type": "string"
            },
            {
              "id": "de5b53c1-3885-4cd9-a593-975588c295a9",
              "name": "=email",
              "value": "={{ $('CRM - Lookup User').item.json.email }}",
              "type": "string"
            },
            {
              "id": "415497c8-1cb5-4616-8c6e-2db7510ca611",
              "name": "=current_status",
              "value": "={{ $('CRM - Lookup User').item.json.current_status }}",
              "type": "string"
            },
            {
              "id": "7acb1d6f-8e52-44ff-b367-11eae94cd374",
              "name": "=conversation_stage",
              "value": "={{ $('CRM - Lookup User').item.json.conversation_stage }}",
              "type": "string"
            },
            {
              "id": "d735ff94-61c1-4c1a-805d-d836dfa357c7",
              "name": "=last_question",
              "value": "={{ $('CRM - Lookup User').item.json.last_question }}",
              "type": "string"
            },
            {
              "id": "8fc77a6e-b906-452c-973e-33741b4fa640",
              "name": "last_agent",
              "value": "={{ $('CRM - Lookup User').item.json.last_agent }}",
              "type": "string"
            },
            {
              "id": "9b1d1b44-ddd6-4f80-a34f-b6e89fc8a914",
              "name": "freebie_sent",
              "value": "={{ $('CRM - Lookup User').item.json.freebie_sent }}",
              "type": "string"
            },
            {
              "id": "aaa20698-1835-4602-a793-453d6329c289",
              "name": "freebie_type",
              "value": "={{ $('CRM - Lookup User').item.json.freebie_type }}",
              "type": "string"
            },
            {
              "id": "aee380f2-5194-45ac-a482-c061b5ad884a",
              "name": "lead_temperature",
              "value": "={{ $('CRM - Lookup User').item.json.lead_temperature }}",
              "type": "string"
            },
            {
              "id": "76ca94db-5755-4a6d-b561-c02e8b766766",
              "name": "coaching_interest",
              "value": "={{ $('CRM - Lookup User').item.json.coaching_interest }}",
              "type": "string"
            },
            {
              "id": "790fc3f7-2264-43d5-b904-c4288edb211f",
              "name": "ticket_level",
              "value": "={{ $('CRM - Lookup User').item.json.ticket_level }}",
              "type": "string"
            },
            {
              "id": "6fbf0553-a52f-454f-a2ab-c9d93f8b8666",
              "name": "goals",
              "value": "={{ $('CRM - Lookup User').item.json.goals }}",
              "type": "string"
            },
            {
              "id": "f6d76ecc-648a-4018-8901-97004e1cff50",
              "name": "pain_points",
              "value": "={{ $('CRM - Lookup User').item.json.pain_points }}",
              "type": "string"
            },
            {
              "id": "753d8d7c-ac2b-4970-99b4-b2019a9b0c78",
              "name": "appointment_interest",
              "value": "={{ $('CRM - Lookup User').item.json.appointment_interest }}",
              "type": "string"
            },
            {
              "id": "612f2403-4544-457a-84ef-c8273ec94389",
              "name": "appointment_link_sent",
              "value": "={{ $('CRM - Lookup User').item.json.appointment_link_sent }}",
              "type": "string"
            },
            {
              "id": "3b7c00c2-2708-4752-a36d-cb0b6d474b9c",
              "name": "conversation_count",
              "value": "={{ $json.conversation_count + 1 }}",
              "type": "string"
            },
            {
              "id": "a9d0faf2-1d8c-4578-8d70-96840ab87419",
              "name": "last_message_user",
              "value": "={{ $node[\"Webhook\"].json.body.entry[0].messaging[0].message.text }}",
              "type": "string"
            },
            {
              "id": "287d9a28-eae2-413b-91ba-9926bca8351c",
              "name": "last_message_bot",
              "value": "={{ $('CRM - Lookup User').item.json.last_message_bot }}",
              "type": "string"
            },
            {
              "id": "555ce122-e0f3-45b5-a9af-d94e30af1d9e",
              "name": "is_new_user",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "id": "01afda0b-6f57-4921-a7cb-41cd3ccdfae1",
      "name": "Load User Context",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -112,
        -1088
      ],
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $node[\"Extract DM Details\"].json.instagram_user_id }}",
            "first_contact": "={{ $now.toISO() }}",
            "last_interaction": "={{ $now.toISO() }}",
            "relationship": "lead",
            "last_message_user": "={{ $node[\"Extract DM Details\"].json.dm_text }}",
            "username": "={{ $node[\"Extract DM Details\"].json.username_from_dm }}",
            "freebie_sent": "FALSE",
            "created_at": "={{ $now.toISO() }}",
            "updated_at": "={{ $now.toISO() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "job",
              "displayName": "job",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "age",
              "displayName": "age",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "first_contact",
              "displayName": "first_contact",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_interaction",
              "displayName": "last_interaction",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_status",
              "displayName": "current_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_question",
              "displayName": "last_question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_agent",
              "displayName": "last_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "relationship",
              "displayName": "relationship",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "goals",
              "displayName": "goals",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "story",
              "displayName": "story",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "pain_points",
              "displayName": "pain_points",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "freebie_sent",
              "displayName": "freebie_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "freebie_type",
              "displayName": "freebie_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "freebie_delivered_at",
              "displayName": "freebie_delivered_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lead_temperature",
              "displayName": "lead_temperature",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "coaching_interest",
              "displayName": "coaching_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ticket_level",
              "displayName": "ticket_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "appointment_interest",
              "displayName": "appointment_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "appointment_link_sent",
              "displayName": "appointment_link_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "appointment_link_sent_at",
              "displayName": "appointment_link_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "calendly_link",
              "displayName": "calendly_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled",
              "displayName": "appointment_scheduled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "appointment_scheduled_at",
              "displayName": "appointment_scheduled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_date",
              "displayName": "appointment_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "appointment_completed",
              "displayName": "appointment_completed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "no_show",
              "displayName": "no_show",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_count",
              "displayName": "conversation_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_message_user",
              "displayName": "last_message_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_bot",
              "displayName": "last_message_bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "tags",
              "displayName": "tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "6e4457ad-a237-4a9d-a465-67f354643800",
      "name": "CRM - Create New User",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -384,
        -912
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=\"{{ $json.current_message }}\"",
        "options": {
          "systemMessage": "=You are the Master Router for an Instagram fitness coaching automation system.\n\n**CRITICAL: YOU MUST CALL ONE AGENT TOOL PER MESSAGE**\n\n**AVAILABLE AGENT TOOLS:**\n\n1. Assesment Agent - For freebie requests and assessment flow\n2. Sales Agent - For post-freebie nurturing and coaching interest\n3. General FAQ Agent1 - For quick fitness/nutrition questions\n\n**AVAILABLE CRM TOOLS:**\n\n4. Get row(s) in sheet in Google Sheets - Read user data (use if needed)\n5. Append or update row in sheet in Google Sheets - Update user data (use after agent)\n\n---\n\n**YOUR WORKFLOW:**\n\nSTEP 1: Read the context you received\nSTEP 2: Decide which agent to call\nSTEP 3: CALL that agent tool (REQUIRED!)\nSTEP 4: Return the agent's response\n\n---\n\n**ROUTING LOGIC (Follow this EXACTLY):**\nIF current_status == \"new\" AND message contains freebie keywords:\n CALL: Assesment Agent\nELSE IF current_status == \"assessment_started\":\n CALL: Assesment Agent\nELSE IF freebie_sent == \"TRUE\" AND message contains coaching keywords:\n CALL: Sales Agent\nELSE IF coaching_interest == \"TRUE\":\n CALL: Sales Agent\nELSE IF message contains question words (wie, was, how, what):\n CALL: General FAQ Agent1\nELSE:\n CALL: General FAQ Agent1 (fallback)\n\n---\n\n**FREEBIE KEYWORDS:**\nguide, pdf, freebie, send, link, kostenlos, gratis, abnehmen, fat loss, calorie, calculator, tdee, rechner\n\n**COACHING KEYWORDS:**\ncoaching, elite, 1on1, personal, help me, zusammenarbeiten, work together, price, cost, angebot, kosten\n\n**QUESTION WORDS:**\nwie, was, warum, sollte, how, what, should, can you\n\n---\n\n**HOW TO CALL AGENT TOOLS:**\n\nWhen you decide on an agent, you MUST use the tool calling function.\n\nExample for Assessment Agent:\n- Tool name: \"Assesment Agent\"\n- Input: The current user message\n\nThe agent will handle the conversation and return their response.\n\n---\n\n**AFTER AGENT RESPONDS:**\n\nYou should CALL \"Append or update row in sheet in Google Sheets\" to update:\n- last_interaction: current timestamp\n- conversation_count: +1  \n- last_agent: [agent name]\n- last_message_user: [user's message]\n- last_message_bot: [agent's response]\n\n---\n\n**YOUR FINAL OUTPUT:**\n\nSimply return the agent's response text.\n\nExample:\n\"Hey! What's your first name? \"\n\nNOT:\n\"I will call Assessment Agent because the user wants a freebie\"\n\nJust the agent's actual message.\n\n---\n\n**CONTEXT YOU HAVE ACCESS TO:**\n\nsender_id: {{ $json.sender_id }}\ncurrent_message: {{ $json.current_message }}\nuser_id: {{ $json.user_id }}\ncurrent_status: {{ $json.current_status }}\nconversation_stage: {{ $json.conversation_stage }}\nlast_question: {{ $json.last_question }}\nlast_agent: {{ $json.last_agent }}\nfreebie_sent: {{ $json.freebie_sent }}\nfreebie_type: {{ $json.freebie_type }}\ncoaching_interest: {{ $json.coaching_interest }}\nlead_temperature: {{ $json.lead_temperature }}\ngoals: {{ $json.goals }}\nemail: {{ $json.email }}\nconversation_count: {{ $json.conversation_count }}\nis_new_user: {{ $json.is_new_user }}\n\nUse these values to make your routing decision.\n\n---\n\n**CRITICAL RULES:**\n\n1. You MUST call exactly ONE agent tool per execution\n2. Do NOT try to answer questions yourself - call the appropriate agent\n3. Follow the routing logic exactly as specified\n4. Always update CRM after agent responds\n5. Return only the agent's response text, nothing else"
        }
      },
      "id": "2f9b0ad2-f05e-4ee7-a1e0-de97d0cfce84",
      "name": "Intent Classifier Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        432,
        -1088
      ]
    },
    {
      "parameters": {
        "model": "openai/gpt-5",
        "options": {
          "maxTokens": 1000,
          "temperature": 0.4
        }
      },
      "id": "61ea102c-f6e8-4e9c-b1d6-c408c15de293",
      "name": "OpenRouter Llama 3.1 8B",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        240,
        -928
      ],
      "credentials": {
        "openRouterApi": {
          "id": "FxVWaStn8r9LRgtp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get raw output from Intent Classifier\nconst rawOutput = $input.item.json.output || '';\n\n// Parse intent and keywords\nlet [intentType, keywords] = rawOutput.trim().toLowerCase().split('|');\nkeywords = keywords || '';\n\nconsole.log('Raw Intent:', intentType);\nconsole.log('Keywords:', keywords);\n\n// Validate intent\nconst validIntents = [\n  'freebie_request',\n  'coaching_interest',\n  'assessment_continue',\n  'general_question',\n  'greeting'\n];\n\nif (!validIntents.includes(intentType)) {\n  console.log('Invalid intent, defaulting to general_question');\n  intentType = 'general_question';\n}\n\n// Get user context\nconst userContext = $('Merge User Context').item.json;\n\n// Freebie Catalog - Hardcoded fr jetzt\nconst freebieCatalog = [\n  {\n    id: 'fat_loss_guide',\n    tags: ['fat loss', 'abnehmen', 'weight loss', 'fettabbau', 'guide', 'lose weight', 'fat']\n  },\n  {\n    id: 'calorie_calculator',\n    tags: ['calorie', 'kalorien', 'tdee', 'rechner', 'calculator', 'berechnen']\n  }\n];\n\n// Match keywords to freebie\nlet matchedFreebie = null;\n\nif (intentType === 'freebie_request' && keywords) {\n  // Score each freebie\n  const scores = freebieCatalog.map(freebie => {\n    let score = 0;\n    freebie.tags.forEach(tag => {\n      if (keywords.includes(tag)) {\n        score += tag.length; // Longer matches = higher score\n      }\n    });\n    return { ...freebie, score };\n  });\n  \n  // Get best match\n  const bestMatch = scores.sort((a, b) => b.score - a.score)[0];\n  \n  if (bestMatch.score > 0) {\n    matchedFreebie = bestMatch.id;\n    console.log('Matched Freebie:', matchedFreebie, 'Score:', bestMatch.score);\n  } else {\n    console.log('No match, defaulting to first freebie');\n    matchedFreebie = freebieCatalog[0].id;\n  }\n}\n\n// Override: If same freebie already sent, don't resend\nif (intentType === 'freebie_request' && \n    userContext.freebie_sent === 'TRUE' && \n    userContext.freebie_type === matchedFreebie) {\n  console.log('Same freebie already sent, switching to general_question');\n  intentType = 'general_question';\n  matchedFreebie = null;\n}\n\nconsole.log('Final Intent:', intentType);\nconsole.log('Final Freebie ID:', matchedFreebie);\n\nreturn {\n  json: {\n    intent: intentType,\n    freebie_id: matchedFreebie,\n    keywords: keywords,\n    raw_output: rawOutput,\n    user_id: userContext.user_id,\n    is_new_user: userContext.is_new_user,\n    freebie_sent: userContext.freebie_sent,\n    classified_at: new Date().toISOString()\n  }\n};"
      },
      "id": "b8eebd38-a310-4c78-b1a4-7ac32080402d",
      "name": "Clean Intent Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -784,
        -640
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Webhook').item.json.body.entry[0].messaging[0].message.text }}",
        "options": {
          "systemMessage": "=You are a friendly fitness coach assistant helping users get a free resource: **{{ $('Load Freebie Config').item.json.freebie_name }}**\n\n**Your Goal:** Conduct a mini-assessment before sending the resource.\n\n**Assessment Questions (ask ONE at a time):**\n1. {{ $('Load Freebie Config').item.json.assessment_q1 }}\n2. {{ $('Load Freebie Config').item.json.assessment_q2 }}\n3. {{ $('Load Freebie Config').item.json.assessment_q3 }}\n\n**Rules:**\n- Be conversational and encouraging\n- Ask questions naturally in German (unless user writes English)\n- Once you have all 3 answers (especially the email), say: \"Perfekt! Ich schicke dir {{ $('Load Freebie Config').item.json.freebie_name }} jetzt zu \"\n- Keep responses under 300 characters\n- Use emojis sparingly (max 1-2 per message)\n- If user already provided email in previous message, acknowledge it and ask remaining questions\n\n**User Context:**\nUser ID: {{ $('Merge User Context').item.json.user_id }}\nConversation Count: {{ $('Merge User Context').item.json.conversation_count }}\nGoals: {{ $('Merge User Context').item.json.goals || 'unknown' }}\n\n**Current Conversation State:**\n{{ $('Merge User Context').item.json.last_intent }}"
        }
      },
      "id": "51fa9580-257b-427f-bfe4-b49d92338922",
      "name": "Universal Freebie Assessment Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        2032,
        272
      ]
    },
    {
      "parameters": {
        "model": "openai/gpt-4o-mini",
        "options": {
          "maxTokens": 300,
          "temperature": 0.7
        }
      },
      "id": "b2c0ab52-bbc7-4141-b647-4d18f2d174fa",
      "name": "OpenRouter GPT-4o-mini",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1952,
        448
      ],
      "credentials": {
        "openRouterApi": {
          "id": "FxVWaStn8r9LRgtp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Merge User Context').item.json.user_id }}_{{ $('Load Freebie Config').item.json.freebie_id }}",
        "contextWindowLength": 10
      },
      "id": "43bca091-a04f-4f21-abca-e8e8835fa71f",
      "name": "Assessment Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        2080,
        448
      ]
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ASSESSMENT COMPLETION DETECTOR\n// ========================================\n\n// Get agent output from Intent Classifier\nconst agentOutput = $input.first().json.output || '';\n\n// Get user context from Merge User Context (for CRM data)\nconst userContext = $('Merge User Context').first().json;\n\n// ========================================\n// EMAIL DETECTION\n// ========================================\n\n// Check if email was just provided in current message\nconst emailRegex = /\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b/;\nconst extractedEmail = agentOutput.match(emailRegex)?.[0] || \n                       userContext.current_message.match(emailRegex)?.[0] || \n                       null;\n\n// Check if email already exists in CRM\nconst emailFromCRM = userContext.email || null;\nconst finalEmail = extractedEmail || emailFromCRM;\n\n// ========================================\n// COMPLETION DETECTION\n// ========================================\n\n// Keywords that indicate assessment is complete\nconst completionPhrases = [\n  'you\\'re all set',\n  'perfekt',\n  'schicke dir',\n  'kommt gleich',\n  'check dein postfach',\n  'check your email',\n  'auf dem weg',\n  'on its way',\n  'in the next few minutes'\n];\n\n// Check if agent said completion phrase\nconst isComplete = completionPhrases.some(phrase => \n  agentOutput.toLowerCase().includes(phrase)\n);\n\n// ========================================\n// FREEBIE TYPE DETECTION\n// ========================================\n\n// Determine freebie type from tags or keywords\nlet freebieId = 'guide'; // Default\n\n// Check CRM tags\nif (userContext.tags && userContext.tags.includes('freebie_interest:calculator')) {\n  freebieId = 'calculator';\n}\n\n// Or check from agent output\nif (agentOutput.toLowerCase().includes('calculator') || \n    agentOutput.toLowerCase().includes('calorie')) {\n  freebieId = 'calculator';\n}\n\n// ========================================\n// READY TO SEND CHECK\n// ========================================\n\n// Assessment is complete AND ready to send if:\n// 1. Agent used completion phrase\n// 2. Email exists (either just extracted or from CRM)\nconst readyToSend = isComplete && finalEmail !== null;\n\n// ========================================\n// OUTPUT\n// ========================================\n\nreturn [{\n  json: {\n    // Completion status\n    assessment_complete: isComplete,\n    ready_to_send: readyToSend,\n    \n    // User data\n    email: finalEmail,\n    user_id: userContext.user_id,\n    recipient_id: userContext.sender_id,\n    \n    // Freebie info\n    freebie_id: freebieId,\n    \n    // Agent response (to send to user)\n    agent_response: agentOutput,\n    \n    // Debug info\n    completion_trigger: isComplete ? 'phrase_detected' : 'not_complete',\n    email_source: extractedEmail ? 'just_extracted' : (emailFromCRM ? 'from_crm' : 'none'),\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "ca1f0f6b-5735-449c-8fb9-6fa2ebf5be31",
      "name": "Extract Assessment Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        848,
        -1088
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "assessment-complete-check",
              "leftValue": "={{ $json.assessment_complete }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "8124b7a2-0fbc-4f0e-9e0d-a86869ae129c",
              "leftValue": "={{ $json.email }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "27becf0f-dc04-48fc-b6a4-91a6f4a76d3b",
      "name": "IF Assessment Complete?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1072,
        -1088
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "continue-text",
              "name": "text_message",
              "value": "={{ $json.agent_response }}",
              "type": "string"
            },
            {
              "id": "continue-recipient",
              "name": "recipient_id",
              "value": "={{ $json.recipient_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "6e497dda-3816-4791-a780-d571b27797a5",
      "name": "Continue Assessment Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1440,
        -1072
      ]
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.file_id }}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {}
          }
        }
      },
      "id": "ef26e19d-31d6-4011-901d-fa57a54c6c3a",
      "name": "Get Google Drive File",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1392,
        -1632
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "kZA0ic6ffpDXSu7G",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "preBuiltAgentsCalloutGoogleDrive": "",
        "authentication": "oAuth2",
        "resource": "file",
        "operation": "share",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.file_id }}",
          "mode": "id"
        },
        "permissionsUi": {},
        "options": {}
      },
      "id": "c346fced-6948-48ae-8ca2-8ef4230b39f3",
      "name": "Share Google Drive File (Public Link)",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1600,
        -1632
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "kZA0ic6ffpDXSu7G",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "freebie_delivery_confirmed": "true",
            "user_id": "={{ $('Extract Assessment Data').item.json.user_id }}",
            "freebie_type": "{{ $('Load Freebie Config').item.json.freebie_id }}",
            "freebie_delivered_at": "={{ $now.toISO() }}",
            "email": "={{ $('Extract Assessment Data').item.json.email }}",
            "lead_temperature": "lead_warm",
            "last_interaction": "={{ $now.toISO() }}"
          },
          "matchingColumns": [
            "user_id"
          ],
          "schema": [
            {
              "id": "lead_temperature",
              "displayName": "lead_temperature",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "instagram_handle",
              "displayName": "instagram_handle",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "first_contact",
              "displayName": "first_contact",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_interaction",
              "displayName": "last_interaction",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "relationship",
              "displayName": "relationship",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "current_intent",
              "displayName": "current_intent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversation_count",
              "displayName": "conversation_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "freebie_type",
              "displayName": "freebie_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "goals",
              "displayName": "goals",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "story",
              "displayName": "story",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "pain_points",
              "displayName": "pain_points",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "coaching_interest",
              "displayName": "coaching_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "intent_history",
              "displayName": "intent_history",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "assessment_data",
              "displayName": "assessment_data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_agent",
              "displayName": "last_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_question",
              "displayName": "last_question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_message_user",
              "displayName": "last_message_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_message_bot",
              "displayName": "last_message_bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "freebie_delivery_confirmed",
              "displayName": "freebie_delivery_confirmed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "freebie_delivered_at",
              "displayName": "freebie_delivered_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "d9415e7d-60f4-4bc7-81c0-6d06dc373ffe",
      "name": "Update CRM - Freebie Sent",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        2336,
        -1632
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "coaching-output",
              "name": "text_message",
              "value": "={{ $json.output }}",
              "type": "string"
            },
            {
              "id": "coaching-recipient",
              "name": "recipient_id",
              "value": "={{ $('Webhook').item.json.body.entry[0].messaging[0].sender.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "33e8bc51-1ed2-481a-b51c-1564b7c26a8d",
      "name": "Format Coaching Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2448,
        304
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "faq-output",
              "name": "text_message",
              "value": "={{ $json.output }}",
              "type": "string"
            },
            {
              "id": "faq-recipient",
              "name": "recipient_id",
              "value": "={{ $('Webhook').item.json.body.entry[0].messaging[0].sender.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "1688ecd9-5c74-408f-b330-6dc08d202040",
      "name": "Format FAQ Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1776,
        976
      ]
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2032,
        960
      ],
      "id": "2311a030-5997-4673-92d8-06f0dfd2ce74",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Facebook Webhook Signature validieren\nconst crypto = require('crypto');\n\nconst signature = $input.item.json.headers['x-hub-signature-256'];\nconst body = JSON.stringify($input.item.json.body);\nconst appSecret = 'DEIN_APP_SECRET'; // Ersetzen!\n\nif (!signature) {\n  throw new Error('Keine Signatur gefunden');\n}\n\nconst expectedSignature = 'sha256=' + crypto\n  .createHmac('sha256', appSecret)\n  .update(body)\n  .digest('hex');\n\nif (signature !== expectedSignature) {\n  throw new Error('Ungltige Signatur - mglicher Fake-Request!');\n}\n\n// Webhook Verification fr Facebook\nif ($input.item.json.query) {\n  const mode = $input.item.json.query['hub.mode'];\n  const token = $input.item.json.query['hub.verify_token'];\n  const challenge = $input.item.json.query['hub.challenge'];\n  \n  if (mode === 'subscribe' && token === 'meinGeheimesToken123') {\n    return [{ json: { challenge: challenge } }];\n  }\n}\n\nreturn $input.all();"
      },
      "name": "Signatur validieren",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1136,
        848
      ],
      "id": "5d319812-9c05-455c-b77a-1ecd93b65c78"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.body.entry[0].changes[0].value.text.toLowerCase() }}",
              "operation": "contains",
              "value2": "guide"
            }
          ]
        }
      },
      "name": "Keyword Filter",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1088,
        560
      ],
      "id": "326a7ddc-1724-4ef2-b66d-f78907f2d09d"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "userId",
              "value": "={{ $('Webhook').first().json.body.entry[0].changes[0].value.from.id }}"
            },
            {
              "name": "username",
              "value": "={{ $('Webhook').first().json.body.entry[0].changes[0].value.from.username }}"
            },
            {
              "name": "commentText",
              "value": "={{ $('Webhook').first().json.body.entry[0].changes[0].value.text }}"
            },
            {
              "name": "commentId",
              "value": "={{ $('Webhook').first().json.body.entry[0].changes[0].value.id }}"
            },
            {
              "name": "mediaId",
              "value": "={{ $('Webhook').first().json.body.entry[0].changes[0].value.media.id }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Daten extrahieren",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        768,
        720
      ],
      "id": "b643d2f8-3a5e-4878-bcc3-e97c0add4bec",
      "disabled": true
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v23.0/{{ $json.body.entry[0].messaging[0].sender.id }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "fields",
              "value": "id,username,profile_pic"
            },
            {
              "name": "access_token",
              "value": "EAAQL9sLFV1EBPw92ytW0g3s0gizhks76afaYCUKdvUvdKIHgHbBVr9rDNvd2uZChY7k0eoMuj0wjiJpSpgBFzjbnFL2P6RlvA6R8u1JrFltU8436ZBd0oLxN02AwlwcdLfdi9UA6zKFsDuy17RX0yMj90ygdtzCtyT8ypoVzX2Q6sHssQZAhvsdEwWCjLMQSDeW"
            }
          ]
        },
        "options": {}
      },
      "name": "User Profil abrufen",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -1776,
        -944
      ],
      "id": "821d5e7b-37f2-4cd8-93b4-0c589ee32558",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v21.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_type\": \"RESPONSE\",\n  \"recipient\": {\n    \"id\": \"{{ $node['Webhook'].json['body']['entry'][0]['changes'][0]['value']['from']['id'] }}\"\n  },\n  \"message\": {\n    \"text\": \"Hey, danke fr deinen Kommentar! Mchtest du den Guide haben?\"\n  }\n}",
        "options": {
          "timeout": 10000
        }
      },
      "name": "Instagram DM senden",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        976,
        720
      ],
      "id": "903257e8-6646-4211-8715-fc21736cda1c",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": "DEINE_GOOGLE_SHEET_ID",
        "sheetName": "Leads",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $now.format('yyyy-MM-dd HH:mm:ss') }}",
            "Name": "={{ $json.name }}",
            "Username": "={{ $json.username }}",
            "User ID": "={{ $json.id }}",
            "Kommentar": "={{ $('Daten extrahieren').item.json.commentText }}",
            "Status": "DM gesendet"
          }
        },
        "options": {}
      },
      "name": "In Google Sheets loggen",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        384,
        1056
      ],
      "id": "9c4c356f-40a9-413d-8c71-ec0e418ae78f",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $credentials.telegramApi.token }}/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "DEINE_TELEGRAM_CHAT_ID"
            },
            {
              "name": "text",
              "value": "= Neuer Lead erfasst!\n\nName: {{ $('User Profil abrufen').item.json.name }}\nUsername: @{{ $('User Profil abrufen').item.json.username }}\nKommentar: {{ $('Daten extrahieren').item.json.commentText }}\nZeit: {{ $now.format('dd.MM.yyyy HH:mm') }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Erfolgs-Benachrichtigung",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        528,
        1056
      ],
      "id": "77e8a0b0-4a9b-482c-81cc-317c14ec1a24",
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=OK",
        "options": {}
      },
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        672,
        1072
      ],
      "id": "1bc56678-678a-4075-9a22-d9add75137cb",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Error Handler\nconst errorDetails = {\n  message: $input.item.json.error?.message || 'Unbekannter Fehler',\n  node: $input.item.json.node?.name || 'Unbekannt',\n  timestamp: new Date().toISOString(),\n  userId: $('Daten extrahieren').item?.json?.userId || 'N/A'\n};\n\nreturn { json: errorDetails };"
      },
      "name": "Error Logger",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1328,
        992
      ],
      "id": "37c25d36-b3e3-489e-bad4-ce3d671f2bfb"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $credentials.telegramApi.token }}/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "DEINE_TELEGRAM_CHAT_ID"
            },
            {
              "name": "text",
              "value": "= FEHLER in Instagram Automation!\n\nFehler: {{ $json.message }}\nNode: {{ $json.node }}\nUser ID: {{ $json.userId }}\nZeit: {{ $json.timestamp }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Error Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -1104,
        992
      ],
      "id": "27a3ba7d-ce16-4aaf-a7e2-3e18363d5ba6"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.crypto",
      "typeVersion": 1,
      "position": [
        -1360,
        736
      ],
      "id": "c647a985-322e-4d91-969e-323d64f03780",
      "name": "Crypto",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        96,
        352
      ],
      "id": "ab8da083-a3da-4652-bcf9-aefe702f8919",
      "name": "Wait3",
      "webhookId": "bb2eac6a-48dc-4abc-965f-12b9567e6446"
    },
    {
      "parameters": {
        "jsCode": "const randomIndex = Math.floor(Math.random() * 3); // 0, 1 oder 2\n\nconst options = [\n  \"Hey! Check your DMs \",\n  \"Guide is waiting for you in your inbox \",\n  \"DM sent youll love this one \"\n];\n\nreturn [\n  {\n    json: {\n      selectedOption: options[randomIndex],\n      randomIndex\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        352
      ],
      "id": "19e3bc0e-de81-48ec-b741-757cd5c0d284",
      "name": "Randomizer1"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1nKHHmjL8qVcz-jz0uBAN_WCE4tcs99WjA3rTR4Rx0Io",
          "mode": "list",
          "cachedResultName": "Whitelist (keine automatisierten Nachrichten)",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nKHHmjL8qVcz-jz0uBAN_WCE4tcs99WjA3rTR4Rx0Io/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nKHHmjL8qVcz-jz0uBAN_WCE4tcs99WjA3rTR4Rx0Io/edit#gid=0"
        },
        "options": {}
      },
      "id": "48d458b3-e79a-4f38-93c1-ab3d88f95088",
      "name": "Lookup in Friends Whitelist1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1632,
        256
      ],
      "alwaysOutputData": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseCode": 200
        }
      },
      "id": "f172d899-8d52-4a76-bddc-b3d1d5845cb9",
      "name": "Silent Response (Friend)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -544,
        80
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "switch-freebie-cal",
                    "leftValue": "={{ $json.matchedKeyword }}",
                    "rightValue": "freebie_calorie_calculator",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Calorie Calculator Flow"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "switch-coaching",
                    "leftValue": "={{ $json.matchedKeyword }}",
                    "rightValue": "elite",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Coaching Interest Flow"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "af67e2c2-0725-4c9c-95b4-4a01d4357cb8",
                    "leftValue": "={{ $json.matchedKeyword }}",
                    "rightValue": "guide",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Fatloss Guide"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0dc1d187-3d12-4a05-bbe9-cc676906a12b",
                    "leftValue": "={{ $json.hasTrigger }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "regular comment"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "a370d2f7-d99d-492d-90b0-72a4451aedf6",
      "name": "Intent Router Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -368,
        352
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -176,
        1184
      ],
      "id": "53a33ad3-cfcc-4b26-9d03-2182a0f1f10e",
      "name": "Wait4",
      "webhookId": "bb2eac6a-48dc-4abc-965f-12b9567e6446"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $('Webhook').item.json.body.entry[0].changes[0].value.id }}/replies",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.selectedOption }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        192,
        1184
      ],
      "id": "5c8b0c5b-2e77-4b46-a65d-5561a67a3c17",
      "name": "Instagram Comment Antwort1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const randomIndex = Math.floor(Math.random() * 3); // 0, 1 oder 2\n\nconst options = [\n  \"Hey! Check your DMs \",\n  \"Guide is waiting for you in your inbox \",\n  \"DM sent youll love this one \"\n];\n\nreturn [\n  {\n    json: {\n      selectedOption: options[randomIndex],\n      randomIndex\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        1184
      ],
      "id": "85d1ee69-0b9e-4183-8e7e-0d04d30cfa69",
      "name": "Randomizer2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        96,
        512
      ],
      "id": "9b311602-918f-4f7e-a39f-b25004fa7d9f",
      "name": "Wait5",
      "webhookId": "bb2eac6a-48dc-4abc-965f-12b9567e6446"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{$node[\"Webhook\"].json[\"body\"][\"entry\"][0][\"changes\"][0][\"value\"][\"id\"]}}/replies",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.selectedOption }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        464,
        512
      ],
      "id": "c90410d2-97e0-440e-819e-b244888edbe6",
      "name": "Instagram Comment Antwort2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const randomIndex = Math.floor(Math.random() * 3); // 0, 1 oder 2\n\nconst options = [\n  \"Hey! Check your DMs \",\n  \"Guide is waiting for you in your inbox \",\n  \"DM sent youll love this one \"\n];\n\nreturn [\n  {\n    json: {\n      selectedOption: options[randomIndex],\n      randomIndex\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        512
      ],
      "id": "709cd6af-99c2-4adc-90ed-15bc529e0fae",
      "name": "Randomizer3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        928,
        880
      ],
      "id": "3a8d8a88-652b-42bf-9948-4d9bf2c939dd",
      "name": "Wait6",
      "webhookId": "bb2eac6a-48dc-4abc-965f-12b9567e6446"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $('Webhook').item.json.body.entry[0].changes[0].value.id }}/replies",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.selectedOption }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1296,
        880
      ],
      "id": "60776d19-bac2-4312-ae66-eff51d4f2cee",
      "name": "Instagram Comment Antwort3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const randomIndex = Math.floor(Math.random() * 3); // 0, 1 oder 2\n\nconst options = [\n  \"Hey! Check your DMs \",\n  \"Guide is waiting for you in your inbox \",\n  \"DM sent youll love this one \"\n];\n\nreturn [\n  {\n    json: {\n      selectedOption: options[randomIndex],\n      randomIndex\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        880
      ],
      "id": "0134ce55-3409-4641-bbdc-940bbc5194a6",
      "name": "Randomizer4"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "userId",
              "value": "={{ $json.body.entry[0].changes[0].value.from.id }}"
            },
            {
              "name": "username",
              "value": "={{ $json.body.entry[0].changes[0].value.from.username }}"
            },
            {
              "name": "commentText",
              "value": "={{ $json.body.entry[0].changes[0].value.text }}"
            },
            {
              "name": "commentId",
              "value": "={{ $json.body.entry[0].changes[0].value.id }}"
            },
            {
              "name": "mediaId",
              "value": "={{ $json.body.entry[0].changes[0].value.media.id }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Daten extrahieren1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        848,
        1024
      ],
      "id": "d8a13f1f-5161-4fa0-8b6b-f50af025a55b"
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $json.userId }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "fields",
              "value": "id,username"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAQL9sLFV1EBPubrWKBiUT0cCP2OeuKoRlNqFttiUe1ueZATxbMjkkFQjbi18wiV58xRqsetGXwiIJ3hLZCOJZAp96iiMwHxfZB3YqL6FgZBNeLzHzQfI4aK2rPZADZBozRUPEvjrydw1HIyfMMkq2MiIZAZCNPJlQwaH6V6AXyzXPjJ6W2yPfoRFZBby2cFTH4BWKFRd66lyI"
            }
          ]
        },
        "options": {}
      },
      "name": "User Profil abrufen1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1024,
        1024
      ],
      "id": "7ab415e9-bd3f-4ab7-9f38-78cd550df102"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v21.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "recipient",
              "value": "={{ { \"id\": $json.id } }}"
            },
            {
              "name": "message",
              "value": "=Appreciate you dropping a comment\nI think youll get a ton of value from this guide, it helped a lot of people already.\nWant me to send it over now?"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "name": "Instagram DM senden1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1216,
        1024
      ],
      "id": "ac7e8112-1385-45df-9127-524d52303aa3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "userId",
              "value": "={{ $json.body.entry[0].changes[0].value.from.id }}"
            },
            {
              "name": "username",
              "value": "={{ $json.body.entry[0].changes[0].value.from.username }}"
            },
            {
              "name": "commentText",
              "value": "={{ $json.body.entry[0].changes[0].value.text }}"
            },
            {
              "name": "commentId",
              "value": "={{ $json.body.entry[0].changes[0].value.id }}"
            },
            {
              "name": "mediaId",
              "value": "={{ $json.body.entry[0].changes[0].value.media.id }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Daten extrahieren2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        992,
        1168
      ],
      "id": "c3eed188-d812-4c43-9594-3dcd290eccef"
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $json.userId }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "fields",
              "value": "id,username"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAQL9sLFV1EBPubrWKBiUT0cCP2OeuKoRlNqFttiUe1ueZATxbMjkkFQjbi18wiV58xRqsetGXwiIJ3hLZCOJZAp96iiMwHxfZB3YqL6FgZBNeLzHzQfI4aK2rPZADZBozRUPEvjrydw1HIyfMMkq2MiIZAZCNPJlQwaH6V6AXyzXPjJ6W2yPfoRFZBby2cFTH4BWKFRd66lyI"
            }
          ]
        },
        "options": {}
      },
      "name": "User Profil abrufen2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1168,
        1168
      ],
      "id": "0041c680-c810-404e-b62b-55e1939712f7"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v21.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "recipient",
              "value": "={{ { \"id\": $json.id } }}"
            },
            {
              "name": "message",
              "value": "=Appreciate you dropping a comment\nI think youll get a ton of value from this guide, it helped a lot of people already.\nWant me to send it over now?"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "name": "Instagram DM senden2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1360,
        1168
      ],
      "id": "54872157-4607-4006-9892-471b5b5e68be",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n  const text = item.json.comment_text || '';\n  item.json.comment_text_normalized = text.toLowerCase().trim();\n  return item;\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -640,
        1040
      ],
      "id": "70cc619f-b407-4bb1-841c-e2c84f3e39fa",
      "name": "Normalize Comment"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1db95bc5-0742-4615-99aa-a948e28c1b54",
              "name": "instagram_user_id",
              "value": "={{ $json.body.entry[0].changes[0].value.from.id }}",
              "type": "string"
            },
            {
              "id": "cf5a267d-efdb-4709-93a5-64cc16d89843",
              "name": "username_from_comment",
              "value": "={{ $json.body.entry[0].changes[0].value.from.username }}",
              "type": "string"
            },
            {
              "id": "6c41bcf8-0eb0-45d8-857b-b4a31b9ca0cb",
              "name": "comment_id",
              "value": "={{ $json.body.entry[0].changes[0].value.id }}",
              "type": "string"
            },
            {
              "id": "5dbf9a35-e0f7-4751-9a36-fd7869c7e2c4",
              "name": "comment_text",
              "value": "={{ $json.body.entry[0].changes[0].value.text }}",
              "type": "string"
            },
            {
              "id": "8eef3b61-b490-40c7-b673-5e614ee5cee1",
              "name": "media_id",
              "value": "={{ $json.body.entry[0].changes[0].value.media.id }}",
              "type": "string"
            },
            {
              "id": "d8bea62c-702b-467e-898e-78e407131fcf",
              "name": "media_type",
              "value": "={{ $json.body.entry[0].changes[0].value.media.media_product_type }}",
              "type": "string"
            },
            {
              "id": "86b997e5-e3f6-4453-9e26-a49395580874",
              "name": "timestamp",
              "value": "={{$now.toISO()}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1920,
        128
      ],
      "id": "006292b1-f49a-4e9d-8da7-f89e8f2c1d59",
      "name": "Extract Comment Details"
    },
    {
      "parameters": {
        "jsCode": "//  Hole alle Usernames aus dem Google Sheet\nconst whitelist = items.map(i => i.json.Username?.toLowerCase().trim());\n\n//  Hole den Username aus dem Kommentar (aus der vorherigen Set-Node)\nconst username = $json[\"username_from_comment\"]?.toLowerCase().trim();\n\n//  Prfe, ob der Username in der Whitelist enthalten ist\nconst isWhitelisted = whitelist.includes(username);\n\n//  Gib das Ergebnis weiter\nreturn [{ json: { isWhitelisted } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1104,
        144
      ],
      "id": "571cc2e7-a2f0-4951-9131-353bb6fa9269",
      "name": "Check Whitelist Match"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1296,
        144
      ],
      "id": "ab91e993-f15d-4423-8dc9-596e76f1d02b",
      "name": "Merge2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cb13043e-455a-472d-bdae-81655a41fa75",
                    "leftValue": "={{ $json.isWhitelisted }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "friend"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.isWhitelisted }}",
                    "rightValue": "false",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    },
                    "id": "f1f84d5e-5c72-4233-83c2-31d8d1a585ca"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "no friend"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -912,
        128
      ],
      "id": "bff6d2e4-41d3-4c32-8c5c-a618c7aef2f8",
      "name": "IF Friend? (Whitelist Check)2",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// === SETTINGS ===\nconst triggerKeywords = [\"elite\", \"coach\", \"guide\", \"calorie\"]; // deine Keywords\n\n// === INPUT ===\nconst commentText = $node[\"Extract Comment Details\"].json[\"comment_text\"]?.toLowerCase() || \"\";\n\n// === LOGIK ===\nconst matchedKeyword = triggerKeywords.find(keyword =>\n  commentText.includes(keyword.toLowerCase())\n);\n\n// === OUTPUT ===\nreturn [\n  {\n    json: {\n      commentText,\n      matchedKeyword: matchedKeyword || null,\n      hasTrigger: !!matchedKeyword\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        352
      ],
      "id": "43cb3c68-3cd9-41f8-9ba5-c27413299093",
      "name": "Trigger-Keyword-Erkennung mit Tippfehler-Toleranz"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -800,
        768
      ],
      "id": "6788761d-c8ed-43c1-8e73-d1759d6a8752",
      "name": "AI Agent2",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $('Webhook').first().json.body.entry[0].changes[0].value.id }}/replies",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.selectedOption }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -272,
        768
      ],
      "id": "e1237d5e-735f-431b-894c-eee360713fcd",
      "name": "Instagram Comment Antwort4",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -480,
        768
      ],
      "id": "46e6abdf-ffe4-4941-aa8e-106c4b1d03c5",
      "name": "Wait7",
      "webhookId": "bb2eac6a-48dc-4abc-965f-12b9567e6446"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        96,
        192
      ],
      "id": "dc48c3a6-d6d8-4827-8c25-afcfc8488029",
      "name": "Wait8",
      "webhookId": "bb2eac6a-48dc-4abc-965f-12b9567e6446"
    },
    {
      "parameters": {
        "jsCode": "const randomIndex = Math.floor(Math.random() * 3); // 0, 1 oder 2\n\nconst options = [\n  \"Hey! Check your DMs \",\n  \"Guide is waiting for you in your inbox \",\n  \"DM sent youll love this one \"\n];\n\nreturn [\n  {\n    json: {\n      selectedOption: options[randomIndex],\n      randomIndex\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        192
      ],
      "id": "2063077a-5927-4408-9d9e-30214305d5d4",
      "name": "Randomizer5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{$node[\"Webhook\"].json[\"body\"][\"entry\"][0][\"changes\"][0][\"value\"][\"id\"]}}/replies",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.selectedOption }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        464,
        192
      ],
      "id": "44b3096f-fe14-4363-9d4a-a8296657fe59",
      "name": "Instagram Comment Antwort",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{$node[\"Webhook\"].json[\"body\"][\"entry\"][0][\"changes\"][0][\"value\"][\"id\"]}}/replies",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.selectedOption }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        464,
        352
      ],
      "id": "c0553b73-9b29-4620-85e8-b392cc5d02f2",
      "name": "Instagram Comment Antwort5",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "options": {}
      },
      "id": "553da77e-2b96-4a6f-9a0b-96fcbb0d6a06",
      "name": "CRM - Lookup User1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        576,
        720
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      },
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "path": "e4f8e3f3-d2eb-4cf6-80a9-586cf723361c",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        1648,
        928
      ],
      "id": "5e4d236c-f07f-48db-ab3d-f2d2b610abc7",
      "name": "Webhook1",
      "webhookId": "e4f8e3f3-d2eb-4cf6-80a9-586cf723361c"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1200,
        720
      ],
      "id": "c95c49f3-0b11-4f80-a9fb-7f738c9d7daa",
      "name": "Execute Workflow",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "//  Hole alle Usernames aus dem Google Sheet (ab Zeile 2)\n// WICHTIG: Das Feld heit \"username\\n\" mit Zeilenumbruch!\nconst whitelist = items\n  .filter(i => i.json.row_number >= 2) // Nur Sheet-Daten, nicht die DM\n  .map(i => i.json[\"username\\n\"]?.toLowerCase().trim())\n  .filter(username => username); // Entferne leere Werte\n\n//  Hole den Username aus dem Instagram DM (aus der ersten Zeile)\nconst username = $json[\"username_from_dm\"]?.toLowerCase().trim();\n\n//  Prfe, ob der Username in der Whitelist enthalten ist\nconst isWhitelisted = whitelist.includes(username);\n\n//  Gib das Ergebnis mit allen relevanten Infos weiter\nreturn [{\n  json: {\n    username: username,\n    isWhitelisted: isWhitelisted,\n    instagram_user_id: $json[\"instagram_user_id\"],\n    dm_text: $json[\"dm_text\"],\n    profile_pic: $json[\"profile_pic\"]\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        -944
      ],
      "id": "7d0c7e15-ad39-464f-a57f-fa9c44c1ca81",
      "name": "Check Whitelist Match1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cb13043e-455a-472d-bdae-81655a41fa75",
                    "leftValue": "={{ $json.isWhitelisted }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "friend"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.isWhitelisted }}",
                    "rightValue": "false",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    },
                    "id": "f1f84d5e-5c72-4233-83c2-31d8d1a585ca"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "no friend"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1264,
        -960
      ],
      "id": "0d5e785d-651c-45d0-b584-f83061ddf083",
      "name": "IF Friend? (Whitelist Check)3",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1db95bc5-0742-4615-99aa-a948e28c1b54",
              "name": "=instagram_user_id",
              "value": "={{ $node[\"User Profil abrufen\"].json.id }}",
              "type": "string"
            },
            {
              "id": "cf5a267d-efdb-4709-93a5-64cc16d89843",
              "name": "=username_from_dm",
              "value": "={{ $node[\"User Profil abrufen\"].json.username }}",
              "type": "string"
            },
            {
              "id": "6c41bcf8-0eb0-45d8-857b-b4a31b9ca0cb",
              "name": "recipient_id",
              "value": "={{ $node[\"Webhook\"].json.body.entry[0].messaging[0].recipient.id }}",
              "type": "string"
            },
            {
              "id": "5dbf9a35-e0f7-4751-9a36-fd7869c7e2c4",
              "name": "dm_text",
              "value": "={{ $node[\"Webhook\"].json.body.entry[0].messaging[0].message.text }}",
              "type": "string"
            },
            {
              "id": "86b997e5-e3f6-4453-9e26-a49395580874",
              "name": "timestamp",
              "value": "={{$now.toISO()}}",
              "type": "string"
            },
            {
              "id": "a0caf923-1785-440e-af11-d0af165b2267",
              "name": "profile_pic",
              "value": "={{ $node[\"User Profil abrufen\"].json.profile_pic }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1024,
        -944
      ],
      "id": "a2e59ace-93f2-4e54-b77b-07c176bf4ae7",
      "name": "Extract DM Details"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": ""
        }
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        2240,
        448
      ],
      "id": "6d7568e6-62a3-422c-8fcd-ca1a86119f98",
      "name": "Get row(s) in sheet in Google Sheets",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Test Processing Pipeline\n",
        "height": 528,
        "width": 624,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2800,
        -1216
      ],
      "typeVersion": 1,
      "id": "f05af01e-6f6d-4531-8efe-a9f03e612c3e",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.instagram.com/v23.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\":{\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"message\":{\n    \"text\":\"{{ $json.text_message.replace(/\\\"/g, '\\\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3504,
        -1008
      ],
      "id": "16d576ac-7c61-4ae6-8fc4-550afdac0ca5",
      "name": "Send Text Response1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Response Handler \n",
        "height": 240,
        "width": 272
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3424,
        -1072
      ],
      "typeVersion": 1,
      "id": "75430527-4cdd-4026-b66d-bdc48268663f",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"typing_on\"\n} ",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2896,
        -1168
      ],
      "id": "b3763326-3d35-4703-b5bd-5cdf76db8b5d",
      "name": "typing_on2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAQL9sLFV1EBPg7ZCx9FZAReG50Fif8gZBGO8JlLqlOxrZAMkbe2u4dg5j7uTVRWu5HTEhNJZBZCfriw3ZAUYAA2hcy2ktIlMHdR6Y1C32KBEsdeLDyx0IZCAfdGC8eWAH4c1ZAVNCe6vA0FYZAhYzcbZBE2E6PUDGRY2FZBJktokl4W1P2VfXZCe8BdtZBEK2nf78znf5ICNS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"mark_seen\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2896,
        -1008
      ],
      "id": "90cf500e-b20b-4446-a319-5f565f2d01e3",
      "name": "mark_seen3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "unit": "=seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2896,
        -848
      ],
      "id": "958acda9-92e5-4153-8a27-27c58908ca5a",
      "name": "Wait9",
      "webhookId": "4dd1678c-fd73-4db3-a990-7ba4cbc927f2"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Merge User Context').item.json.sender_id }}",
        "contextWindowLength": 100
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        320,
        -288
      ],
      "id": "531c4fe0-1114-4af8-8fcc-8bc6c016bd53",
      "name": "Simple Memory3"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "user_id",
              "lookupValue": "={{ $('Merge User Context').item.json.sender_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        832,
        -896
      ],
      "id": "81ff93e9-06f6-4c29-bd65-a74d8e84cb28",
      "name": "Get row(s) in sheet in Google Sheets2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}",
        "options": {
          "systemMessage": "=You are a friendly fitness coach assistant conducting a comprehensive assessment before sending a free resource.\n\n**YOUR MISSION:**\nBuild rapport and collect qualifying information (name, story, job, age, goal, email) - then deliver the freebie.\n\n**IMPORTANT:**\n- You have access to conversation memory (shared across all agents)\n- You can see recent messages via memory\n- You have access to CRM via Google Sheets tools\n- User's current message is provided to you\n\n**YOUR PROCESS (MULTI-STEP ASSESSMENT):**\n\n**PHASE 1: Name Collection**\n\nWhen user first requests freebie:\n\nResponse template:\n\"Hey! So glad you're interested in finally starting your fitness journey! \nBy the way, what's your first name? It's always easier to support someone when I know their name \"\n\n Tool Call: Update CRM\ncurrent_status: \"assessment_started\"\nlast_question: \"name\"\nconversation_stage: \"opt_in\"\n\n---\n\n**PHASE 2: Story Collection**\n\nWhen user provides name:\n\nResponse template:\n\"Nice to meet you, [Name]! \nJust curious...what's your fitness and health story? Everyone's got a journey, a struggle, or a goal they've been chasing...\nI'd love to hear yours :)\"\n\n Tool Call: Update CRM\nfirst_name: [extracted name]\nlast_question: \"story\"\n\n---\n\n**PHASE 3: Job Collection**\n\nWhen user shares story:\n\nResponse template:\n\"Thanks for sharing! That's powerful \nEveryone's routine is different...sometimes work makes it harder to stay consistent with fitness and nutrition.\nWhat's your job? Helps me picture your day a bit \"\n\n Tool Call: Update CRM\nstory: [user's story]\nlast_question: \"job\"\n\n---\n\n**PHASE 4: Age Collection**\n\nWhen user mentions job:\n\nResponse template:\n\"Ok I see, sounds like a lot of work...\nTo get a clearer picture - can I ask how old you are?\"\n\n Tool Call: Update CRM\njob: [user's job]\nlast_question: \"age\"\n\n---\n\n**PHASE 5: Goal Collection**\n\nWhen user provides age:\n\nResponse template:\n\"Thanks for being so open! This really helps me understand you better \nQuick: What's your main fitness goal right now?\n(Lose fat / Build muscle / Get stronger)\"\n\n Tool Call: Update CRM\nage: [extracted number]\nlast_question: \"goal\"\n\n---\n\n**PHASE 6: Email Collection**\n\nWhen user states goal:\n\nResponse template:\n\"Perfect! [Acknowledge their goal] \nJust in case the [Freebie Name] doesn't load well on Instagram, I'll also send it to your email so you don't miss it.\nWhat's the best email to send it to?\"\n\n Tool Call: Update CRM\ngoals: [user's goal]\nlast_question: \"email\"\n\n---\n\n**PHASE 7: Freebie Delivery**\n\nWhen email detected:\n\nResponse template:\n\"You're all set! \nCan't wait for you to get started with your [goal] journey!\nCheck your email in the next few minutes (also spam folder) - the guide is on its way \"\n\n Tool Call: Update CRM\nemail: [extracted email]\nfreebie_sent: TRUE\nfreebie_type: \"guide\"\ncurrent_status: \"lead_warm\"\nconversation_stage: \"post_freebie\"\nlast_question: \"completed\"\n\n---\n\n**TOOLS YOU MUST USE:**\n\n1. **Get row(s) in sheet in Google Sheets**\n   - Use at START to check: What was last_question?\n   - This tells you which phase you're in\n\n2. **Append or update row in sheet in Google Sheets**\n   - Use AFTER each response to save data and update last_question\n\n**WORKFLOW:**\n\n1. CALL \"Get row(s)\" to check last_question\n2. Based on last_question, determine current phase:\n   - null/\"name\"  Phase 1 (ask name)\n   - \"story\"  Phase 2 (ask story)\n   - \"job\"  Phase 3 (ask job)\n   - \"age\"  Phase 4 (ask age)\n   - \"goal\"  Phase 5 (ask goal)\n   - \"email\"  Phase 6 (ask email)\n   - If email in message  Phase 7 (delivery)\n3. Generate appropriate response\n4. CALL \"Append or update\" to save data\n5. RETURN your message\n\n**RESPONSE STYLE:**\n\nLength: 120-200 characters per message\n\nTone:\n- Warm and conversational\n- Use their first name when you have it\n- German or English based on user's language\n- 1-2 emojis max\n- Casual, not corporate\n\n**EDGE CASES:**\n\nIf user provides multiple answers in one message:\n Extract all data, skip to next unanswered question\n\nExample:\nUser: \"I'm Max, 30, work as a teacher, want to lose 20kg, my email is max@test.com\"\n Extract: name, age, job, goal, email\n Go directly to Phase 7 (delivery)\n\nIf user asks questions:\n Answer briefly, then redirect: \"But first, [current question]?\"\n\nIf user goes off-topic:\n Gently redirect: \"Haha, cool! But let's focus on your fitness for a sec - [current question]?\"\n\n**DATA EXTRACTION:**\n\n- Name: First capitalized word that looks like a name\n- Age: Any number between 15-80\n- Email: Standard email regex pattern\n- Job: Whatever they say (store as-is)\n- Story: Their full message (store as-is)\n- Goal: Keywords: \"lose\", \"build\", \"stronger\", \"abnehmen\", \"muscle\"\n\n**CRITICAL RULES:**\n\n1. ALWAYS call \"Get row(s)\" FIRST to check last_question\n2. ALWAYS update CRM AFTER your response\n3. NEVER skip phases (follow order: name  story  job  age  goal  email)\n4. Keep each message focused on ONE question\n5. Be patient - this is about building rapport, not rushing to email\n\n**FREEBIE MAPPING:**\n\nBased on initial request keywords:\n- \"guide\", \"abnehmen\", \"fat loss\"  Fat Loss Guide\n- \"calculator\", \"calorie\", \"tdee\"  Calorie Calculator\n- If unclear  Default to Fat Loss Guide\n\n**OUTPUT:**\nOnly return your message text.\n\nExample: \"Hey! What's your first name? \"\nNOT: \"I will ask for their name because...\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        848,
        -512
      ],
      "id": "f14e3830-cc66-4427-9791-c687ccb9057c",
      "name": "Assesment Agent"
    },
    {
      "parameters": {
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}",
        "options": {
          "systemMessage": "=You are an elite fitness coach conducting consultative sales conversations via Instagram DM.\n\n**YOUR MISSION:**\nGuide leads from freebie download to booking a coaching consultation - through value, empathy, and strategic questioning.\n\n**CONTEXT YOU RECEIVE:**\n\nFrom CRM:\n- email (they already opted in)\n- goals (their stated objective)\n- freebie_type (what they downloaded)\n- conversation_count (how many interactions)\n- lead_temperature (cold/warm/hot)\n- pain_points (discovered in previous convos)\n- coaching_interest (TRUE/FALSE)\n\nFrom Memory:\n- Recent conversation history (last 100 messages)\n\n**YOUR CONVERSATION FRAMEWORK:**\n\n**STAGE 1: VALUE DELIVERY (conversation_count 1-3)**\n\nGoal: Build trust, answer freebie questions\n\nResponse style:\n- Answer their questions thoroughly\n- Reference specific sections of the freebie they got\n- Ask casual follow-up: \"Was war dein grter Takeaway aus dem Guide?\"\n- Length: 250-350 characters\n\nExample:\"Great question! In the guide (page 12) habe ich genau das erklrt \n[Answer their question]\nQuick: Was war dein grter Aha-Moment aus dem Guide?\"\n Tool Call: Update CRM\n```javascript\n{\n  conversation_stage: \"value_delivery\",\n  last_interaction: now\n}\n```\n\n**STAGE 2: CURIOSITY & PAIN DISCOVERY (conversation_count 4-6)**\n\nGoal: Understand their real challenges\n\nStrategic questions (ask ONE per message):\n1. \"Was ist aktuell deine grte Herausforderung mit [their goal]?\"\n2. \"Wie lange kmpfst du schon damit?\"\n3. \"Was hast du schon alles probiert?\"\n4. \"Was hat dich bisher davon abgehalten?\"\n\nResponse style:\n- Empathetic listening\n- Mirror their language\n- Length: 300-500 characters (allow longer here!)\n\nExample:\"Das kenne ich von so vielen Leuten \n[Acknowledge their pain]\nEhrliche Frage: Was hast du schon alles probiert, um das zu lsen?\"\n Tool Call: Update CRM\n```javascript\n{\n  conversation_stage: \"pain_discovery\",\n  pain_points: \"extracted from their message\",\n  lead_temperature: \"warm\"\n}\n```\n\n**STAGE 3: DREAM STATE (conversation_count 7-8)**\n\nGoal: Get them to visualize success\n\nQuestions:\n- \"Wenn du in 3 Monaten dein Ziel erreichst - wie wrde sich dein Leben ndern?\"\n- \"Was wre anders, wenn du endlich [their goal] geschafft httest?\"\n\nResponse style:\n- Paint the picture with them\n- Build emotional connection\n- Length: 250-400 characters\n\n Tool Call: Update CRM\n```javascript\n{\n  conversation_stage: \"dream_state\",\n  lead_temperature: \"hot\"\n}\n```\n\n**STAGE 4: BRIDGE TO COACHING (conversation_count 9+)**\n\nGoal: Position coaching as natural next step\n\nApproach:\n- Reference their pain points from CRM\n- Show understanding of their journey\n- Introduce coaching subtly\n\nExample:\"Ich verstehe total, dass [pain point] frustrierend ist.\nDie meisten meiner Clients hatten genau das gleiche Problem. Was ihnen geholfen hat: Ein klarer Plan + jemand, der sie accountable hlt.\nWrst du offen fr ein kurzes Gesprch darber, wie das bei dir aussehen knnte? \"\n Tool Call: Update CRM\n```javascript\n{\n  conversation_stage: \"coaching_pitch\",\n  coaching_interest: TRUE,\n  lead_temperature: \"hot\"\n}\n```\n\n**STAGE 5: CALENDLY CTA (if coaching_interest = TRUE)**\n\nGoal: Book the call\n\nApproach:\n- Low-pressure\n- Time-conscious\n- Clear next step\n\nExample:\"Cool! Lass uns 15min telefonieren.\nIch schau mir deine Situation an und sag dir ehrlich, ob ich helfen kann.\nWann passt dir diese Woche? \n[Calendly Link]\"\n Tool Call: Update CRM\n```javascript\n{\n  conversation_stage: \"appointment_offered\",\n  appointment_link_sent: TRUE\n}\n```\n\n**TOOLS YOU MUST USE:**\n\n1. **Get row(s) in sheet in Google Sheets**\n   - Use to: Load user context at conversation start\n   - Critical: Check conversation_stage, pain_points, lead_temperature\n\n2. **Append or update row in sheet in Google Sheets**\n   - Use to: Update conversation_stage after each interaction\n   - Update: pain_points, lead_temperature, coaching_interest\n\n**RESPONSE LENGTH RULES:**\n\nCritical: Sales is about CONNECTION, not brevity.\n\n- Value delivery: 250-350 chars\n- Pain discovery: 300-500 chars (allow depth!)\n- Dream state: 250-400 chars\n- Coaching pitch: 350-500 chars\n- Calendly CTA: 150-200 chars\n\n**TONALITY ADAPTATION:**\n\nMirror the user's energy:\n- Short messages  match brevity\n- Long, detailed messages  go deeper, show you care\n- Emotional sharing  be empathetic, take time to acknowledge\n\n**TICKET-LEVEL IDENTIFICATION:**\n\nBased on conversation, tag in CRM:\n\n**Low Ticket ($300-500):**\n- Budget conscious\n- DIY mindset\n- Wants templates/programs\n\n Set tag: \"ticket_level:low\"\n\n**Mid Ticket ($800-1500):**\n- Wants guidance + accountability\n- Has some experience\n- Ready to invest in results\n\n Set tag: \"ticket_level:mid\"\n\n**High Ticket ($2000+):**\n- Values transformation\n- Executive/high earner\n- Wants premium 1-on-1 attention\n- Mentions time constraints\n\n Set tag: \"ticket_level:high\"\n\n**CRITICAL RULES:**\n\n1. NEVER rush to pitch - earn the right through value\n2. ALWAYS update CRM with pain_points when discovered\n3. Use conversation_stage to know where you are\n4. If user asks direct coaching questions  move faster to pitch\n5. If user goes cold  back off, provide more value\n6. Quality > Quantity - one deep convo > 10 surface ones\n\n**EDGE CASES:**\n\nIf user asks about price too early:\n \"Great question! It depends on your specific goals. Lass uns kurz telefonieren - dann kann ich dir genau sagen, was Sinn macht.\"\n\nIf user has objections:\n Acknowledge, don't argue. \"Ich verstehe [objection]. Viele meiner Clients dachten das auch am Anfang...\"\n\nIf user goes silent:\n Wait 48h, then: \"Hey! Wie luft's mit dem Guide? \" (re-engage with value)\n\n**DO NOT:**\n- Spam multiple messages without response\n- Use corporate/salesy language\n- Discount or defend pricing\n- Make promises about results\n- Rush the process"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        496,
        -512
      ],
      "id": "cab398cb-4540-4c6b-b8b1-bd30292b9675",
      "name": "Sales Agent"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $('Merge User Context').item.json.sender_id }}"
          },
          "matchingColumns": [
            "user_id"
          ],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "job",
              "displayName": "job",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "age",
              "displayName": "age",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_contact",
              "displayName": "first_contact",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_interaction",
              "displayName": "last_interaction",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_status",
              "displayName": "current_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_question",
              "displayName": "last_question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_agent",
              "displayName": "last_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "relationship",
              "displayName": "relationship",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "goals",
              "displayName": "goals",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "story",
              "displayName": "story",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pain_points",
              "displayName": "pain_points",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_sent",
              "displayName": "freebie_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "freebie_type",
              "displayName": "freebie_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_delivered_at",
              "displayName": "freebie_delivered_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_temperature",
              "displayName": "lead_temperature",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "coaching_interest",
              "displayName": "coaching_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ticket_level",
              "displayName": "ticket_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_interest",
              "displayName": "appointment_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent",
              "displayName": "appointment_link_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent_at",
              "displayName": "appointment_link_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendly_link",
              "displayName": "calendly_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled",
              "displayName": "appointment_scheduled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled_at",
              "displayName": "appointment_scheduled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_date",
              "displayName": "appointment_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_completed",
              "displayName": "appointment_completed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "no_show",
              "displayName": "no_show",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_count",
              "displayName": "conversation_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_user",
              "displayName": "last_message_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_bot",
              "displayName": "last_message_bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tags",
              "displayName": "tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        1008,
        -896
      ],
      "id": "59642e87-bf9c-40ef-bac3-dc958d15b552",
      "name": "Append or update row in sheet in Google Sheets",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "user_id",
              "lookupValue": "={{ $('Merge User Context').item.json.sender_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        944,
        -160
      ],
      "id": "938625df-5921-4c75-a8b2-e75182195cf7",
      "name": "Get row(s) in sheet in Google Sheets4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $('Merge User Context').item.json.sender_id }}",
            "username": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('username', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "phone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('phone', ``, 'string') }}",
            "first_contact": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('first_contact', ``, 'string') }}",
            "last_interaction": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_interaction', ``, 'string') }}",
            "current_status": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('current_status', ``, 'string') }}",
            "conversation_stage": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_stage', ``, 'string') }}",
            "last_question": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_question', ``, 'string') }}",
            "last_agent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_agent', ``, 'string') }}",
            "relationship": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('relationship', ``, 'string') }}",
            "goals": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('goals', ``, 'string') }}",
            "story": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('story', ``, 'string') }}",
            "pain_points": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('pain_points', ``, 'string') }}",
            "freebie_sent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_sent', ``, 'string') }}",
            "freebie_type": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_type', ``, 'string') }}",
            "freebie_delivered_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_delivered_at', ``, 'string') }}",
            "lead_temperature": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_temperature', ``, 'string') }}",
            "coaching_interest": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('coaching_interest', ``, 'string') }}",
            "ticket_level": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ticket_level', ``, 'string') }}",
            "appointment_interest": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_interest', ``, 'string') }}",
            "appointment_link_sent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_link_sent', ``, 'string') }}",
            "appointment_link_sent_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_link_sent_at', ``, 'string') }}",
            "calendly_link": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendly_link', ``, 'string') }}",
            "appointment_scheduled": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_scheduled', ``, 'string') }}",
            "appointment_scheduled_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_scheduled_at', ``, 'string') }}",
            "appointment_date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_date', ``, 'string') }}",
            "appointment_completed": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_completed', ``, 'string') }}",
            "no_show": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('no_show', ``, 'string') }}",
            "conversation_count": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_count', ``, 'string') }}",
            "last_message_user": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_message_user', ``, 'string') }}",
            "last_message_bot": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_message_bot', ``, 'string') }}",
            "tags": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('tags', ``, 'string') }}",
            "notes": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('notes', ``, 'string') }}",
            "created_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('created_at', ``, 'string') }}",
            "updated_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('updated_at', ``, 'string') }}"
          },
          "matchingColumns": [
            "user_id"
          ],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "job",
              "displayName": "job",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "age",
              "displayName": "age",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_contact",
              "displayName": "first_contact",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_interaction",
              "displayName": "last_interaction",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_status",
              "displayName": "current_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_question",
              "displayName": "last_question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_agent",
              "displayName": "last_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "relationship",
              "displayName": "relationship",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "goals",
              "displayName": "goals",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "story",
              "displayName": "story",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pain_points",
              "displayName": "pain_points",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_sent",
              "displayName": "freebie_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "freebie_type",
              "displayName": "freebie_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_delivered_at",
              "displayName": "freebie_delivered_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_temperature",
              "displayName": "lead_temperature",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "coaching_interest",
              "displayName": "coaching_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ticket_level",
              "displayName": "ticket_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_interest",
              "displayName": "appointment_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent",
              "displayName": "appointment_link_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent_at",
              "displayName": "appointment_link_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendly_link",
              "displayName": "calendly_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled",
              "displayName": "appointment_scheduled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled_at",
              "displayName": "appointment_scheduled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_date",
              "displayName": "appointment_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_completed",
              "displayName": "appointment_completed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "no_show",
              "displayName": "no_show",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_count",
              "displayName": "conversation_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_user",
              "displayName": "last_message_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_bot",
              "displayName": "last_message_bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tags",
              "displayName": "tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        1120,
        -160
      ],
      "id": "e88b7046-f319-4595-a512-3b980f051941",
      "name": "Append or update row in sheet in Google Sheets2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 250,
          "temperature": 0.6
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        848,
        -336
      ],
      "id": "a48527ad-b57d-4a3f-83c0-e2ba7e7aac41",
      "name": "OpenRouter Chat Model3",
      "credentials": {
        "openRouterApi": {
          "id": "FxVWaStn8r9LRgtp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 500,
          "temperature": 0.8
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        464,
        -320
      ],
      "id": "80ff7b2f-588a-49bf-8035-f410252a4437",
      "name": "OpenRouter Chat Model4",
      "credentials": {
        "openRouterApi": {
          "id": "FxVWaStn8r9LRgtp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 300,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -80,
        -272
      ],
      "id": "d29b6f6d-f683-4638-bfde-bbbd6dd184e1",
      "name": "OpenRouter Chat Model5",
      "credentials": {
        "openRouterApi": {
          "id": "FxVWaStn8r9LRgtp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1s9NzzvtKcOIIYNzS3mbadoLsmmyPW6HCGCiil8HulXk",
          "mode": "list",
          "cachedResultName": "Freebie_Catalog",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1s9NzzvtKcOIIYNzS3mbadoLsmmyPW6HCGCiil8HulXk/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1s9NzzvtKcOIIYNzS3mbadoLsmmyPW6HCGCiil8HulXk/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "file_id",
              "lookupValue": "={{ $('Extract Assessment Data').item.json.freebie_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1200,
        -1632
      ],
      "id": "65ce1449-6ad5-4470-8f5a-fec13bb13ebb",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"typing_on\"\n} ",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1792,
        -1632
      ],
      "id": "d0a80a66-0aa4-4082-96c4-e62a4297cb9f",
      "name": "typing_on3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v23.0/796534800210682/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAQL9sLFV1EBPg7ZCx9FZAReG50Fif8gZBGO8JlLqlOxrZAMkbe2u4dg5j7uTVRWu5HTEhNJZBZCfriw3ZAUYAA2hcy2ktIlMHdR6Y1C32KBEsdeLDyx0IZCAfdGC8eWAH4c1ZAVNCe6vA0FYZAhYzcbZBE2E6PUDGRY2FZBJktokl4W1P2VfXZCe8BdtZBEK2nf78znf5ICNS"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $json.recipient_id }}\"\n  },\n  \"sender_action\": \"mark_seen\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1792,
        -1472
      ],
      "id": "2d60235e-6ab0-4605-aaba-c56ebc277e0f",
      "name": "mark_seen4",
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "unit": "=seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1792,
        -1312
      ],
      "id": "eca3328e-c130-475e-8cf0-02f88279bb4c",
      "name": "Wait10",
      "webhookId": "4dd1678c-fd73-4db3-a990-7ba4cbc927f2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.instagram.com/v23.0/me/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $('Extract Assessment Data').item.json.recipient_id }}\"\n  },\n  \"message\": {\n    \"text\": \" Perfekt! Hier ist dein {{ $('Extract Assessment Data').item.json.freebie_name }}!\\n\\n Download: {{ $json.webViewLink }}\\n\\nViel Erfolg auf deinem Weg! \\n\\nFragen? Schreib mir einfach!\"\n  }\n}",
        "options": {}
      },
      "id": "10af5f5a-c10e-4002-9212-c4a6c42868d7",
      "name": "Send Freebie + Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2144,
        -1632
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "IpjcD7KLigEJw5OC",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 300,
          "temperature": 0.5
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -576,
        -272
      ],
      "id": "ed247ab8-43a2-4ed3-b933-f767a99a01d6",
      "name": "OpenRouter Chat Model2",
      "credentials": {
        "openRouterApi": {
          "id": "FxVWaStn8r9LRgtp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3c537fe8-a588-4526-86e5-512464e74807",
              "name": "user_id",
              "value": "={{ $json.user_id }}",
              "type": "string"
            },
            {
              "id": "27619db6-83fc-45fc-a548-2d101b4a4975",
              "name": "username",
              "value": "={{ $json.username }}",
              "type": "string"
            },
            {
              "id": "de5b53c1-3885-4cd9-a593-975588c295a9",
              "name": "email",
              "value": "=",
              "type": "string"
            },
            {
              "id": "415497c8-1cb5-4616-8c6e-2db7510ca611",
              "name": "current_status",
              "value": "=new",
              "type": "string"
            },
            {
              "id": "7acb1d6f-8e52-44ff-b367-11eae94cd374",
              "name": "conversation_stage",
              "value": "=",
              "type": "string"
            },
            {
              "id": "d735ff94-61c1-4c1a-805d-d836dfa357c7",
              "name": "last_question",
              "value": "=",
              "type": "string"
            },
            {
              "id": "8fc77a6e-b906-452c-973e-33741b4fa640",
              "name": "last_agent",
              "value": "=",
              "type": "string"
            },
            {
              "id": "9b1d1b44-ddd6-4f80-a34f-b6e89fc8a914",
              "name": "freebie_sent",
              "value": "=FALSE",
              "type": "string"
            },
            {
              "id": "aaa20698-1835-4602-a793-453d6329c289",
              "name": "freebie_type",
              "value": "=",
              "type": "string"
            },
            {
              "id": "aee380f2-5194-45ac-a482-c061b5ad884a",
              "name": "lead_temperature",
              "value": "=",
              "type": "string"
            },
            {
              "id": "76ca94db-5755-4a6d-b561-c02e8b766766",
              "name": "coaching_interest",
              "value": "=",
              "type": "string"
            },
            {
              "id": "790fc3f7-2264-43d5-b904-c4288edb211f",
              "name": "ticket_level",
              "value": "=",
              "type": "string"
            },
            {
              "id": "6fbf0553-a52f-454f-a2ab-c9d93f8b8666",
              "name": "goals",
              "value": "=",
              "type": "string"
            },
            {
              "id": "f6d76ecc-648a-4018-8901-97004e1cff50",
              "name": "pain_points",
              "value": "=",
              "type": "string"
            },
            {
              "id": "753d8d7c-ac2b-4970-99b4-b2019a9b0c78",
              "name": "appointment_interest",
              "value": "=",
              "type": "string"
            },
            {
              "id": "612f2403-4544-457a-84ef-c8273ec94389",
              "name": "appointment_link_sent",
              "value": "=",
              "type": "string"
            },
            {
              "id": "3b7c00c2-2708-4752-a36d-cb0b6d474b9c",
              "name": "conversation_count",
              "value": "=1",
              "type": "string"
            },
            {
              "id": "a9d0faf2-1d8c-4578-8d70-96840ab87419",
              "name": "last_message_user",
              "value": "={{ $node[\"Webhook\"].json.body.entry[0].messaging[0].message.text }}",
              "type": "string"
            },
            {
              "id": "287d9a28-eae2-413b-91ba-9926bca8351c",
              "name": "last_message_bot",
              "value": "=",
              "type": "string"
            },
            {
              "id": "555ce122-e0f3-45b5-a9af-d94e30af1d9e",
              "name": "is_new_user",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "id": "c3c0d2ba-977b-4a19-b6fd-7d7653301f69",
      "name": "Load User Context1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -112,
        -912
      ],
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "user_id",
              "lookupValue": "={{ $('Merge User Context').item.json.sender_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        592,
        -208
      ],
      "id": "3604972e-c8c4-41b0-bb3c-2a64bfee3e43",
      "name": "Get row(s) in sheet in Google Sheets5",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "user_id",
              "lookupValue": "={{ $('Merge User Context').item.json.sender_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        64,
        -256
      ],
      "id": "a29f2832-2704-45cd-a9e4-2198a5110c2b",
      "name": "Get row(s) in sheet in Google Sheets6",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "user_id",
              "lookupValue": "={{ $('Merge User Context').item.json.sender_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        -400,
        -256
      ],
      "id": "56289057-30ea-4239-be0c-36d08f16694c",
      "name": "Get row(s) in sheet in Google Sheets7",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $('Merge User Context').item.json.sender_id }}",
            "username": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('username', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "phone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('phone', ``, 'string') }}",
            "first_contact": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('first_contact', ``, 'string') }}",
            "last_interaction": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_interaction', ``, 'string') }}",
            "current_status": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('current_status', ``, 'string') }}",
            "conversation_stage": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_stage', ``, 'string') }}",
            "last_question": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_question', ``, 'string') }}",
            "last_agent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_agent', ``, 'string') }}",
            "relationship": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('relationship', ``, 'string') }}",
            "goals": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('goals', ``, 'string') }}",
            "story": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('story', ``, 'string') }}",
            "pain_points": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('pain_points', ``, 'string') }}",
            "freebie_sent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_sent', ``, 'string') }}",
            "freebie_type": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_type', ``, 'string') }}",
            "freebie_delivered_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_delivered_at', ``, 'string') }}",
            "lead_temperature": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_temperature', ``, 'string') }}",
            "coaching_interest": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('coaching_interest', ``, 'string') }}",
            "ticket_level": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ticket_level', ``, 'string') }}",
            "appointment_interest": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_interest', ``, 'string') }}",
            "appointment_link_sent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_link_sent', ``, 'string') }}",
            "appointment_link_sent_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_link_sent_at', ``, 'string') }}",
            "calendly_link": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendly_link', ``, 'string') }}",
            "appointment_scheduled": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_scheduled', ``, 'string') }}",
            "appointment_scheduled_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_scheduled_at', ``, 'string') }}",
            "appointment_date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_date', ``, 'string') }}",
            "appointment_completed": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_completed', ``, 'string') }}",
            "no_show": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('no_show', ``, 'string') }}",
            "conversation_count": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_count', ``, 'string') }}",
            "last_message_user": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_message_user', ``, 'string') }}",
            "last_message_bot": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_message_bot', ``, 'string') }}",
            "tags": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('tags', ``, 'string') }}",
            "notes": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('notes', ``, 'string') }}",
            "created_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('created_at', ``, 'string') }}",
            "updated_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('updated_at', ``, 'string') }}"
          },
          "matchingColumns": [
            "user_id"
          ],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "job",
              "displayName": "job",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "age",
              "displayName": "age",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_contact",
              "displayName": "first_contact",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_interaction",
              "displayName": "last_interaction",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_status",
              "displayName": "current_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_question",
              "displayName": "last_question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_agent",
              "displayName": "last_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "relationship",
              "displayName": "relationship",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "goals",
              "displayName": "goals",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "story",
              "displayName": "story",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pain_points",
              "displayName": "pain_points",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_sent",
              "displayName": "freebie_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "freebie_type",
              "displayName": "freebie_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_delivered_at",
              "displayName": "freebie_delivered_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_temperature",
              "displayName": "lead_temperature",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "coaching_interest",
              "displayName": "coaching_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ticket_level",
              "displayName": "ticket_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_interest",
              "displayName": "appointment_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent",
              "displayName": "appointment_link_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent_at",
              "displayName": "appointment_link_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendly_link",
              "displayName": "calendly_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled",
              "displayName": "appointment_scheduled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled_at",
              "displayName": "appointment_scheduled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_date",
              "displayName": "appointment_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_completed",
              "displayName": "appointment_completed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "no_show",
              "displayName": "no_show",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_count",
              "displayName": "conversation_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_user",
              "displayName": "last_message_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_bot",
              "displayName": "last_message_bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tags",
              "displayName": "tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        752,
        -208
      ],
      "id": "67e05bcf-473f-4b35-8482-5a29da5d9b40",
      "name": "Append or update row in sheet in Google Sheets3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $('Merge User Context').item.json.sender_id }}",
            "username": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('username', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "phone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('phone', ``, 'string') }}",
            "first_contact": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('first_contact', ``, 'string') }}",
            "last_interaction": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_interaction', ``, 'string') }}",
            "current_status": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('current_status', ``, 'string') }}",
            "conversation_stage": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_stage', ``, 'string') }}",
            "last_question": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_question', ``, 'string') }}",
            "last_agent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_agent', ``, 'string') }}",
            "relationship": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('relationship', ``, 'string') }}",
            "goals": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('goals', ``, 'string') }}",
            "story": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('story', ``, 'string') }}",
            "pain_points": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('pain_points', ``, 'string') }}",
            "freebie_sent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_sent', ``, 'string') }}",
            "freebie_type": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_type', ``, 'string') }}",
            "freebie_delivered_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_delivered_at', ``, 'string') }}",
            "lead_temperature": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_temperature', ``, 'string') }}",
            "coaching_interest": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('coaching_interest', ``, 'string') }}",
            "ticket_level": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ticket_level', ``, 'string') }}",
            "appointment_interest": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_interest', ``, 'string') }}",
            "appointment_link_sent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_link_sent', ``, 'string') }}",
            "appointment_link_sent_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_link_sent_at', ``, 'string') }}",
            "calendly_link": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendly_link', ``, 'string') }}",
            "appointment_scheduled": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_scheduled', ``, 'string') }}",
            "appointment_scheduled_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_scheduled_at', ``, 'string') }}",
            "appointment_date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_date', ``, 'string') }}",
            "appointment_completed": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_completed', ``, 'string') }}",
            "no_show": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('no_show', ``, 'string') }}",
            "conversation_count": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_count', ``, 'string') }}",
            "last_message_user": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_message_user', ``, 'string') }}",
            "last_message_bot": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_message_bot', ``, 'string') }}",
            "tags": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('tags', ``, 'string') }}",
            "notes": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('notes', ``, 'string') }}",
            "created_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('created_at', ``, 'string') }}",
            "updated_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('updated_at', ``, 'string') }}"
          },
          "matchingColumns": [
            "user_id"
          ],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "job",
              "displayName": "job",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "age",
              "displayName": "age",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_contact",
              "displayName": "first_contact",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_interaction",
              "displayName": "last_interaction",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_status",
              "displayName": "current_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_question",
              "displayName": "last_question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_agent",
              "displayName": "last_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "relationship",
              "displayName": "relationship",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "goals",
              "displayName": "goals",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "story",
              "displayName": "story",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pain_points",
              "displayName": "pain_points",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_sent",
              "displayName": "freebie_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "freebie_type",
              "displayName": "freebie_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_delivered_at",
              "displayName": "freebie_delivered_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_temperature",
              "displayName": "lead_temperature",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "coaching_interest",
              "displayName": "coaching_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ticket_level",
              "displayName": "ticket_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_interest",
              "displayName": "appointment_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent",
              "displayName": "appointment_link_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent_at",
              "displayName": "appointment_link_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendly_link",
              "displayName": "calendly_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled",
              "displayName": "appointment_scheduled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled_at",
              "displayName": "appointment_scheduled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_date",
              "displayName": "appointment_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_completed",
              "displayName": "appointment_completed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "no_show",
              "displayName": "no_show",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_count",
              "displayName": "conversation_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_user",
              "displayName": "last_message_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_bot",
              "displayName": "last_message_bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tags",
              "displayName": "tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        208,
        -256
      ],
      "id": "1f8a5d1e-ce0d-4590-afaa-f1894851a4f8",
      "name": "Append or update row in sheet in Google Sheets4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw",
          "mode": "list",
          "cachedResultName": "Leads Database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Tabellenblatt1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1BLVzObJaiFr7mzMzRCvxlrC1DXG9B1Gp39izcZTH2gw/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $('Merge User Context').item.json.sender_id }}",
            "username": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('username', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "phone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('phone', ``, 'string') }}",
            "first_contact": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('first_contact', ``, 'string') }}",
            "last_interaction": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_interaction', ``, 'string') }}",
            "current_status": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('current_status', ``, 'string') }}",
            "conversation_stage": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_stage', ``, 'string') }}",
            "last_question": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_question', ``, 'string') }}",
            "last_agent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_agent', ``, 'string') }}",
            "relationship": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('relationship', ``, 'string') }}",
            "goals": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('goals', ``, 'string') }}",
            "story": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('story', ``, 'string') }}",
            "pain_points": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('pain_points', ``, 'string') }}",
            "freebie_sent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_sent', ``, 'string') }}",
            "freebie_type": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_type', ``, 'string') }}",
            "freebie_delivered_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('freebie_delivered_at', ``, 'string') }}",
            "lead_temperature": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_temperature', ``, 'string') }}",
            "coaching_interest": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('coaching_interest', ``, 'string') }}",
            "ticket_level": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ticket_level', ``, 'string') }}",
            "appointment_interest": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_interest', ``, 'string') }}",
            "appointment_link_sent": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_link_sent', ``, 'string') }}",
            "appointment_link_sent_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_link_sent_at', ``, 'string') }}",
            "calendly_link": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendly_link', ``, 'string') }}",
            "appointment_scheduled": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_scheduled', ``, 'string') }}",
            "appointment_scheduled_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_scheduled_at', ``, 'string') }}",
            "appointment_date": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_date', ``, 'string') }}",
            "appointment_completed": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('appointment_completed', ``, 'string') }}",
            "no_show": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('no_show', ``, 'string') }}",
            "conversation_count": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_count', ``, 'string') }}",
            "last_message_user": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_message_user', ``, 'string') }}",
            "last_message_bot": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('last_message_bot', ``, 'string') }}",
            "tags": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('tags', ``, 'string') }}",
            "notes": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('notes', ``, 'string') }}",
            "created_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('created_at', ``, 'string') }}",
            "updated_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('updated_at', ``, 'string') }}"
          },
          "matchingColumns": [
            "user_id"
          ],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "job",
              "displayName": "job",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "age",
              "displayName": "age",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_contact",
              "displayName": "first_contact",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_interaction",
              "displayName": "last_interaction",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_status",
              "displayName": "current_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_question",
              "displayName": "last_question",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_agent",
              "displayName": "last_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "relationship",
              "displayName": "relationship",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "goals",
              "displayName": "goals",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "story",
              "displayName": "story",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pain_points",
              "displayName": "pain_points",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_sent",
              "displayName": "freebie_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "freebie_type",
              "displayName": "freebie_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "freebie_delivered_at",
              "displayName": "freebie_delivered_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_temperature",
              "displayName": "lead_temperature",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "coaching_interest",
              "displayName": "coaching_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ticket_level",
              "displayName": "ticket_level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_interest",
              "displayName": "appointment_interest",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent",
              "displayName": "appointment_link_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_link_sent_at",
              "displayName": "appointment_link_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendly_link",
              "displayName": "calendly_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled",
              "displayName": "appointment_scheduled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_scheduled_at",
              "displayName": "appointment_scheduled_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_date",
              "displayName": "appointment_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "appointment_completed",
              "displayName": "appointment_completed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "no_show",
              "displayName": "no_show",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversation_count",
              "displayName": "conversation_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_message_user",
              "displayName": "last_message_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_message_bot",
              "displayName": "last_message_bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tags",
              "displayName": "tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        -240,
        -256
      ],
      "id": "80afcbe4-22eb-4722-9387-37039efbdede",
      "name": "Append or update row in sheet in Google Sheets5",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Xwpxycduk2ofs5iU",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// INTELLIGENT CONTEXT ROUTER + SENDER ID EXTRACTOR\n// VERSION 2.0 - With extended CRM fields\n// ========================================\n\n// Get all items from both routes\nconst allItems = items;\n\n// Initialize context object\nlet userContext = null;\n\n// Check which route was executed\nif (allItems && allItems.length > 0) {\n  // Take the first (and only) item from whichever route executed\n  userContext = allItems[0].json;\n}\n\n// Extract Sender ID from Webhook (for AI Agent Session)\nconst webhookData = $('Webhook').first().json;\nconst senderId = webhookData?.body?.entry?.[0]?.messaging?.[0]?.sender?.id || 'unknown';\n\n// Get current message text for reference\nconst messageText = webhookData?.body?.entry?.[0]?.messaging?.[0]?.message?.text || '';\n\n// Build standardized output with ALL fields + sender_id\nconst standardizedContext = {\n  // === EXTRACTED SENDER ID (for AI Session) ===\n  sender_id: senderId,\n  current_message: messageText,\n  \n  // === Core Identity ===\n  user_id: userContext?.user_id || '',\n  username: userContext?.username || '',\n  first_name: userContext?.first_name || '',\n  age: userContext?.age || null,\n  job: userContext?.job || '',\n  email: userContext?.email || '',\n  phone: userContext?.phone || '',\n  \n  // === Status & Stage ===\n  current_status: userContext?.current_status || 'new',\n  conversation_stage: userContext?.conversation_stage || '',\n  last_question: userContext?.last_question || '',\n  last_agent: userContext?.last_agent || '',\n  relationship: userContext?.relationship || 'lead',\n  \n  // === Freebie ===\n  freebie_sent: userContext?.freebie_sent || 'FALSE',\n  freebie_type: userContext?.freebie_type || '',\n  freebie_delivered_at: userContext?.freebie_delivered_at || '',\n  \n  // === Lead Scoring ===\n  lead_temperature: userContext?.lead_temperature || 'cold',\n  coaching_interest: userContext?.coaching_interest || 'FALSE',\n  ticket_level: userContext?.ticket_level || '',\n  \n  // === Discovery ===\n  goals: userContext?.goals || '',\n  story: userContext?.story || '',\n  pain_points: userContext?.pain_points || '',\n  \n  // === Appointment ===\n  appointment_interest: userContext?.appointment_interest || 'FALSE',\n  appointment_link_sent: userContext?.appointment_link_sent || 'FALSE',\n  appointment_scheduled: userContext?.appointment_scheduled || 'FALSE',\n  appointment_date: userContext?.appointment_date || '',\n  calendly_link: userContext?.calendly_link || '',\n  \n  // === Metrics ===\n  conversation_count: userContext?.conversation_count || 1,\n  last_message_user: userContext?.last_message_user || messageText,\n  last_message_bot: userContext?.last_message_bot || '',\n  \n  // === Metadata ===\n  first_contact: userContext?.first_contact || '',\n  last_interaction: userContext?.last_interaction || '',\n  tags: userContext?.tags || '',\n  notes: userContext?.notes || '',\n  \n  // === Flag ===\n  is_new_user: userContext?.is_new_user || false,\n  \n  // === Debug ===\n  route_taken: userContext?.is_new_user ? 'new_user' : 'existing_user',\n  timestamp: new Date().toISOString()\n};\n\n// Return standardized context\nreturn [{\n  json: standardizedContext\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        -1088
      ],
      "id": "1493bc21-dfe1-483a-a854-25a30feb122d",
      "name": "Merge User Context"
    },
    {
      "parameters": {
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}",
        "options": {
          "systemMessage": "=You are an appointment scheduling specialist for a fitness coaching business.\n\n**YOUR MISSION:**\nConvert hot leads into booked consultation calls through Calendly - smoothly and professionally.\n\n**CONTEXT YOU RECEIVE:**\n\nFrom CRM:\n- coaching_interest (should be TRUE to reach you)\n- lead_temperature (warm/hot)\n- goals (their stated objective)\n- pain_points (discovered challenges)\n- conversation_stage (should be near coaching_pitch)\n- appointment_link_sent (TRUE/FALSE)\n- appointment_scheduled (TRUE/FALSE)\n\nFrom Memory:\n- Recent conversation context\n\n**YOUR PROCESS:**\n\n**PHASE 1: Qualify Interest**\n\nIf first time user reaches you:\n\nResponse template:\"Perfect! Lass uns 15-20min telefonieren.\nIch schau mir deine Situation an und sag dir ehrlich, ob und wie ich helfen kann.\nPasst dir diese Woche? \"\n Wait for confirmation\n\n---\n\n**PHASE 2: Send Calendly Link**\n\nOnce user confirms interest:\n\nResponse template:\"Cool! Such dir hier einen Slot aus, der passt:\n[CALENDLY_LINK]\nDauert max 20min - kein Verkaufsgesprch, versprochen \nFreu mich drauf!\"\n**CALENDLY LINK STRUCTURE:**\n Tool Call: Update CRM\n```javascript\n{\n  appointment_link_sent: TRUE,\n  appointment_link_sent_at: current_timestamp,\n  calendly_link: generated_link,\n  conversation_stage: \"appointment_offered\"\n}\n```\n\n---\n\n**PHASE 3: Booking Confirmation**\n\nIf user says \"Booked!\" or similar:\n\nResponse template:\"Perfekt! \nCheck deine Email fr die Zoom-Details.\nQuick prep: berleg dir schon mal dein #1 Ziel fr die nchsten 3 Monate.\nBis dann! \"\n Tool Call: Update CRM\n```javascript\n{\n  appointment_scheduled: TRUE,\n  appointment_scheduled_at: current_timestamp,\n  conversation_stage: \"appointment_scheduled\",\n  lead_temperature: \"hot\"\n}\n```\n\n---\n\n**PHASE 4: No Response Follow-up**\n\nIf appointment_link_sent = TRUE but no booking after 24h:\n\n(This would be triggered by a separate scheduled workflow)\n\nResponse template:\n\"Hey! Hast du schon einen Slot gefunden? \nFalls die Zeiten nicht passen, sag Bescheid - dann finden wir was anderes!\"\n---\n\n**EDGE CASES:**\n\n**User hesitates:**\n\"I'm not sure if I have time...\"\n\nResponse:\"Totally verstehe ich! Es sind nur 15min.\nWorst case: Du lernst was ber deinen aktuellen Plan.\nBest case: Wir finden raus, wie du schneller ans Ziel kommst \"\n**User asks about price before booking:**\n\"How much is coaching?\"\n\nResponse:\"Fair question! Es hngt von deinem Ziel und Timeline ab.\nRanges von 800-2000 ber 3-6 Monate.\nIm Call besprechen wir, was fr dich Sinn macht. Deal?\"\n**User wants to chat more before booking:**\n\"Can we discuss more here first?\"\n\nResponse:\"Klar knnten wir - aber ehrlich: DMs sind mega ineffizient \n15min Call > 50 Messages hin und her.\nWas hlt dich ab?\"\n If valid objection  address it\n If just stalling  soft push to book\n\n---\n\n**TOOLS YOU MUST USE:**\n\n1. **Get row(s) in sheet in Google Sheets**\n   - Load: goals, pain_points, coaching_interest, appointment_link_sent\n\n2. **Append or update row in sheet in Google Sheets**\n   - Update: appointment_link_sent, appointment_scheduled, calendly_link\n\n**RESPONSE STYLE:**\n\nLength: 150-250 characters (clear CTAs, not too wordy)\n\nTone:\n- Professional but casual\n- Low-pressure (no hard selling)\n- Excited but not pushy\n- Use emojis sparingly (   )\n\n**CRITICAL RULES:**\n\n1. NEVER send Calendly link without qualifying interest first\n2. ALWAYS personalize the Calendly link with user data\n3. NEVER oversell - keep it consultative (\"see if I can help\")\n4. If user books  immediately update CRM\n5. Keep follow-ups light and helpful, not spammy\n\n**DO NOT:**\n- Send link in first message\n- Promise guaranteed results\n- Make the call sound like a sales pitch\n- Spam multiple follow-ups if no response\n\n**CALENDLY BEST PRACTICES:**\n\nPre-populate Calendly URL with:\n- Name: {{ username or email prefix }}\n- Email: {{ email from CRM }}\n- Notes: \"Goal: {{ goals }} | Challenges: {{ pain_points }}\"\n\nThis saves time on the call and shows you're prepared!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        -448,
        -496
      ],
      "id": "94aaf566-ad6e-45fd-b2e8-5c0def44d79a",
      "name": "Appointment scheduling Agent"
    },
    {
      "parameters": {
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}",
        "options": {
          "systemMessage": "=You are a knowledgeable fitness coach answering quick questions on Instagram DM.\n\n**YOUR ROLE:**\nProvide accurate, science-based answers to fitness and nutrition questions - quickly and helpfully.\n\n**IMPORTANT:**\n- You have access to conversation memory (recent messages)\n- You can check CRM via Google Sheets tools\n- User's current message is provided to you\n\n**YOUR RESPONSE FRAMEWORK:**\n\n**QUESTION TYPES:**\n\n**1. Training Questions**\nExamples:\n- \"Wie oft sollte ich trainieren?\"\n- \"Push/Pull/Legs oder Fullbody?\"\n- \"Cardio vor oder nach Krafttraining?\"\n\nResponse template:\n[Direct answer with reasoning]\n[Optional: Quick follow-up based on their goal if known from CRM]\n\nLength: 200-300 characters\n\n---\n\n**2. Nutrition Questions**\nExamples:\n- \"Wie viel Protein brauche ich?\"\n- \"Sind Cheat Meals okay?\"\n- \"Meal Timing wichtig?\"\n\nResponse template:\n[Science-based answer]\n[Optional: \"Bei deinem Ziel [goal from CRM] wrde ich...\"]\n\nLength: 200-300 characters\n\n---\n\n**3. Supplement Questions**\nExamples:\n- \"Brauche ich Protein Powder?\"\n- \"Was ist mit Creatine?\"\n\nResponse template:\n[Honest, no-BS answer]\n[If relevant: \"Das bespreche ich auch im Guide, Seite X\"]\n\n---\n\n**4. Product/Service Questions**\nExamples:\n- \"Was bietest du an?\"\n- \"Hast du Programme?\"\n- \"Do you do coaching?\"\n\nResponse:\n\"Yeah! Ich helfe [target audience] mit [specific outcome].\nAber erstmal: Was ist deine grte Herausforderung gerade?\"\n\n Tool Call: Update CRM\ncoaching_interest: TRUE\nlead_temperature: \"warm\"\nlast_agent: \"faq\"\n\n Note: Next message will route to Sales Agent\n\n---\n\n**COACHING INTEREST DETECTION:**\n\nIf user asks ANY of these  update CRM:\n- \"Do you do coaching?\"\n- \"How can you help me?\"\n- \"I need help with...\"\n- \"Can you train me?\"\n- \"What do you offer?\"\n\n**TOOLS YOU USE:**\n\n1. **Get row(s) in sheet in Google Sheets**\n   - Optional: Check if user has freebie, their goals\n   - Use to personalize answers\n\n2. **Append or update row in sheet in Google Sheets**\n   - Required: If coaching_interest detected\n   - Always: Update last_interaction timestamp\n\n**WORKFLOW:**\n\n1. Read user's question\n2. Optional: CALL \"Get row(s)\" if you need context (goals, freebie status)\n3. Generate science-based answer\n4. If coaching interest detected:\n   - CALL \"Append or update\" with coaching_interest = TRUE\n5. RETURN your answer\n\n**RESPONSE STYLE:**\n\nLength: 200-300 characters (brief and helpful)\n\nTone:\n- Direct and factual\n- No fluff or corporate speak\n- Science-based but accessible\n- German or English based on user's language\n\nStructure:\n[Answer in 1-2 sentences]\n[Optional follow-up question if relevant]\n\nExamples:\n\n BAD:\n\"Das ist eine super Frage! Also grundstzlich gibt es da verschiedene Anstze und Studien zeigen...\"\n\n GOOD:\n\"3-4x Krafttraining pro Woche ist optimal fr die meisten.\n\nBei deinem Ziel (Muskelaufbau) wrde ich 4x empfehlen \"\n\n**KNOWLEDGE BASE:**\n\nTraining:\n- Frequency: 3-5x/week for most goals\n- Volume: 10-20 sets per muscle per week\n- Progressive overload: Key principle\n\nNutrition:\n- Protein: 1.6-2.2g per kg bodyweight\n- Calorie deficit: 300-500 kcal for fat loss\n- Meal timing: Less important than total intake\n\nSupplements:\n- Essential: Protein powder (convenience), Creatine (proven)\n- Optional: Pre-workout, BCAAs\n- Not needed: Fat burners, detox teas\n\n**EDGE CASES:**\n\nComplex questions:\n \"Das ist zu komplex fr eine DM. Lass uns kurz telefonieren?\"\n Update CRM: coaching_interest = TRUE\n\nFreebie-covered topics:\n \"Das ist im Guide auf Seite X! Hast du ihn schon durchgelesen?\"\n\nUnrelated questions:\n \"Haha, gute Frage! Aber ich bin nur fr Fitness-Zeug zustndig \"\n\n**CRITICAL RULES:**\n\n1. NEVER pitch coaching unless they ask\n2. ALWAYS keep answers under 300 characters\n3. If coaching interest detected  update CRM immediately\n4. Use memory to avoid repeating answers\n5. Be helpful, not salesy\n\n**DO NOT:**\n- Give medical advice (injuries, health conditions)\n- Prescribe specific diets without context\n- Make guarantees about results\n- Argue with bro-science (just give facts)\n\n**OUTPUT:**\nOnly return your answer text.\n\nExample: \"3-4x Krafttraining ist optimal \"\nNOT: \"The user asked about training frequency, so I will answer...\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        64,
        -512
      ],
      "id": "c3113219-0aaa-45c3-ada4-f9060b5b65b4",
      "name": "General FAQ Agent"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Message Type Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Webhook Verification Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Router": {
      "main": [
        [
          {
            "node": "Check Echo1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Echo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Comment Details",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Echo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Echo": {
      "main": [
        [],
        []
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        []
      ]
    },
    "Check Echo1": {
      "main": [
        [],
        [
          {
            "node": "User Profil abrufen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Prepare Image Response Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Image Response Data": {
      "main": [
        [
          {
            "node": "typing_on1",
            "type": "main",
            "index": 0
          },
          {
            "node": "mark_seen1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          },
          {
            "node": "mark_seen2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Audio Response Type Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Audio Response Type Check": {
      "main": [
        [
          {
            "node": "Randomizer",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Generate AI Voice Response": {
      "main": [
        [
          {
            "node": "CloudConvert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Audio to Drive": {
      "main": [
        [
          {
            "node": "Upload to Meta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Send Text Response": {
      "main": [
        []
      ]
    },
    "call_button": {
      "main": [
        []
      ]
    },
    "quick_reply": {
      "main": [
        []
      ]
    },
    "typing_on": {
      "main": [
        []
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Send Text Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        []
      ]
    },
    "Upload to Meta": {
      "main": [
        [
          {
            "node": "Send Voice Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request10": {
      "main": [
        []
      ]
    },
    "CloudConvert": {
      "main": [
        [
          {
            "node": "Upload Audio to Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Randomizer": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Generate AI Voice Response",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Content type switch": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Facebook Graph API": {
      "main": [
        []
      ]
    },
    "Lookup in Friends Whitelist": {
      "main": [
        [
          {
            "node": "Check Whitelist Match1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Friend? (Whitelist Check)": {
      "main": [
        [],
        []
      ]
    },
    "CRM - Lookup User": {
      "main": [
        [
          {
            "node": "IF User Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF User Exists?": {
      "main": [
        [
          {
            "node": "Load User Context",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CRM - Create New User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load User Context": {
      "main": [
        [
          {
            "node": "Merge User Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CRM - Create New User": {
      "main": [
        [
          {
            "node": "Load User Context1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intent Classifier Agent": {
      "main": [
        [
          {
            "node": "Extract Assessment Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Llama 3.1 8B": {
      "ai_languageModel": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Clean Intent Output": {
      "main": [
        []
      ]
    },
    "Universal Freebie Assessment Agent": {
      "main": [
        []
      ]
    },
    "OpenRouter GPT-4o-mini": {
      "ai_languageModel": [
        [
          {
            "node": "Universal Freebie Assessment Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Assessment Memory": {
      "ai_memory": [
        [
          {
            "node": "Universal Freebie Assessment Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Extract Assessment Data": {
      "main": [
        [
          {
            "node": "IF Assessment Complete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Assessment Complete?": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Continue Assessment Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Google Drive File": {
      "main": [
        [
          {
            "node": "Share Google Drive File (Public Link)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Share Google Drive File (Public Link)": {
      "main": [
        [
          {
            "node": "typing_on3",
            "type": "main",
            "index": 0
          },
          {
            "node": "mark_seen4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update CRM - Freebie Sent": {
      "main": [
        []
      ]
    },
    "Format Coaching Response": {
      "main": [
        []
      ]
    },
    "Format FAQ Response": {
      "main": [
        []
      ]
    },
    "Merge": {
      "main": [
        []
      ]
    },
    "Signatur validieren": {
      "main": [
        []
      ]
    },
    "Keyword Filter": {
      "main": [
        []
      ]
    },
    "Daten extrahieren": {
      "main": [
        [
          {
            "node": "Instagram DM senden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Profil abrufen": {
      "main": [
        [
          {
            "node": "Lookup in Friends Whitelist",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram DM senden": {
      "main": [
        [
          {
            "node": "Execute Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "In Google Sheets loggen": {
      "main": [
        [
          {
            "node": "Erfolgs-Benachrichtigung",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Erfolgs-Benachrichtigung": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "Randomizer1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Randomizer1": {
      "main": [
        [
          {
            "node": "Instagram Comment Antwort5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lookup in Friends Whitelist1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ],
        []
      ]
    },
    "Intent Router Switch": {
      "main": [
        [
          {
            "node": "Wait8",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait4": {
      "main": [
        [
          {
            "node": "Randomizer2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Randomizer2": {
      "main": [
        [
          {
            "node": "Instagram Comment Antwort1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait5": {
      "main": [
        [
          {
            "node": "Randomizer3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Randomizer3": {
      "main": [
        [
          {
            "node": "Instagram Comment Antwort2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait6": {
      "main": [
        [
          {
            "node": "Randomizer4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Randomizer4": {
      "main": [
        [
          {
            "node": "Instagram Comment Antwort3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daten extrahieren1": {
      "main": [
        [
          {
            "node": "User Profil abrufen1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Profil abrufen1": {
      "main": [
        [
          {
            "node": "Instagram DM senden1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daten extrahieren2": {
      "main": [
        [
          {
            "node": "User Profil abrufen2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Profil abrufen2": {
      "main": [
        [
          {
            "node": "Instagram DM senden2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Comment": {
      "main": [
        []
      ]
    },
    "Extract Comment Details": {
      "main": [
        [
          {
            "node": "Lookup in Friends Whitelist1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Check Whitelist Match",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Whitelist Match": {
      "main": [
        [
          {
            "node": "IF Friend? (Whitelist Check)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Friend? (Whitelist Check)2": {
      "main": [
        [
          {
            "node": "Silent Response (Friend)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Trigger-Keyword-Erkennung mit Tippfehler-Toleranz",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger-Keyword-Erkennung mit Tippfehler-Toleranz": {
      "main": [
        [
          {
            "node": "Intent Router Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent2": {
      "main": [
        [
          {
            "node": "Wait7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait7": {
      "main": [
        [
          {
            "node": "Instagram Comment Antwort4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait8": {
      "main": [
        [
          {
            "node": "Randomizer5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Randomizer5": {
      "main": [
        [
          {
            "node": "Instagram Comment Antwort",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram Comment Antwort2": {
      "main": [
        [
          {
            "node": "CRM - Lookup User1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CRM - Lookup User1": {
      "main": [
        [
          {
            "node": "Daten extrahieren",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Whitelist Match1": {
      "main": [
        [
          {
            "node": "IF Friend? (Whitelist Check)3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Friend? (Whitelist Check)3": {
      "main": [
        [
          {
            "node": "Silent Response (Friend)1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract DM Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract DM Details": {
      "main": [
        [
          {
            "node": "CRM - Lookup User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet in Google Sheets": {
      "ai_tool": [
        [
          {
            "node": "Universal Freebie Assessment Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Wait9": {
      "main": [
        [
          {
            "node": "Send Text Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory3": {
      "ai_memory": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Assesment Agent",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Sales Agent",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "General FAQ Agent",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Appointment scheduling Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet in Google Sheets2": {
      "ai_tool": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Assesment Agent": {
      "ai_tool": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Sales Agent": {
      "ai_tool": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Continue Assessment Response": {
      "main": [
        [
          {
            "node": "typing_on",
            "type": "main",
            "index": 0
          },
          {
            "node": "mark_seen",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet in Google Sheets": {
      "ai_tool": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet in Google Sheets4": {
      "ai_tool": [
        [
          {
            "node": "Assesment Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet in Google Sheets2": {
      "ai_tool": [
        [
          {
            "node": "Assesment Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Assesment Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Sales Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "General FAQ Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Get Google Drive File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Freebie + Message": {
      "main": [
        [
          {
            "node": "Update CRM - Freebie Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait10": {
      "main": [
        [
          {
            "node": "Send Freebie + Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Appointment scheduling Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Load User Context1": {
      "main": [
        [
          {
            "node": "Merge User Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet in Google Sheets7": {
      "ai_tool": [
        [
          {
            "node": "Appointment scheduling Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet in Google Sheets5": {
      "ai_tool": [
        [
          {
            "node": "Appointment scheduling Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet in Google Sheets6": {
      "ai_tool": [
        [
          {
            "node": "General FAQ Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet in Google Sheets4": {
      "ai_tool": [
        [
          {
            "node": "General FAQ Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet in Google Sheets5": {
      "ai_tool": [
        [
          {
            "node": "Sales Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet in Google Sheets3": {
      "ai_tool": [
        [
          {
            "node": "Sales Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Merge User Context": {
      "main": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Appointment scheduling Agent": {
      "ai_tool": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "General FAQ Agent": {
      "ai_tool": [
        [
          {
            "node": "Intent Classifier Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "10d1976a-ccae-49e5-891b-ab128d9de4cf",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0715144e16c01a32819f4cf3dd4288d967166a06566af2271b171f08c2f45d52"
  },
  "id": "i14W22c2QYBydU4y",
  "tags": []
}